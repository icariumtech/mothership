---
phase: 03-encounter-tokens
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - terminal/models.py
  - terminal/views.py
  - terminal/urls.py
  - terminal/data_loader.py
  - src/types/encounterMap.ts
  - src/services/encounterApi.ts
autonomous: true

must_haves:
  truths:
    - "Token state persists in ActiveView and survives page refreshes"
    - "API endpoints accept place, move, remove, update-status, and clear-all operations"
    - "Token images can be listed from campaign entity directories"
    - "Active view API returns encounter_tokens for player polling"
    - "TypeScript types match the backend token data structure"
  artifacts:
    - path: "terminal/models.py"
      provides: "encounter_tokens JSONField on ActiveView"
      contains: "encounter_tokens"
    - path: "terminal/views.py"
      provides: "Token CRUD API endpoints + token images listing"
      exports: ["api_encounter_place_token", "api_encounter_move_token", "api_encounter_remove_token", "api_encounter_update_token_status", "api_encounter_clear_tokens", "api_encounter_token_images"]
    - path: "terminal/urls.py"
      provides: "URL routes for token APIs"
      contains: "encounter/place-token"
    - path: "src/types/encounterMap.ts"
      provides: "TokenData, TokenType, TokenStatus, TokenState interfaces"
      contains: "TokenData"
    - path: "src/services/encounterApi.ts"
      provides: "Token API client functions"
      exports: ["placeToken", "moveToken", "removeToken", "updateTokenStatus", "clearAllTokens", "getTokenImages"]
  key_links:
    - from: "terminal/views.py"
      to: "terminal/models.py"
      via: "ActiveView.encounter_tokens JSONField read/write"
      pattern: "encounter_tokens"
    - from: "src/services/encounterApi.ts"
      to: "terminal/urls.py"
      via: "API endpoint URLs"
      pattern: "encounter.*token"
    - from: "terminal/views.py (get_active_view_json)"
      to: "ActiveView.encounter_tokens"
      via: "JSON serialization in active-view response"
      pattern: "encounter_tokens"
---

<objective>
Backend data layer for encounter tokens: model field, CRUD API endpoints, token image listing, TypeScript types, and API client.

Purpose: Establish the data foundation that token rendering and GM controls depend on. Token state stored in ActiveView.encounter_tokens JSONField (matching existing room_visibility and door_status patterns). Token images served from campaign entity directories.

Output: Working API endpoints for token CRUD, token image discovery, TypeScript types, and API client functions.
</objective>

<execution_context>
@/home/gjohnson/.claude/get-shit-done/workflows/execute-plan.md
@/home/gjohnson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-encounter-tokens/03-CONTEXT.md
@.planning/phases/03-encounter-tokens/03-RESEARCH.md
@terminal/models.py
@terminal/views.py
@terminal/urls.py
@terminal/data_loader.py
@src/types/encounterMap.ts
@src/services/encounterApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ActiveView model field, migration, and token CRUD API endpoints</name>
  <files>
    terminal/models.py
    terminal/views.py
    terminal/urls.py
    terminal/data_loader.py
  </files>
  <action>
1. Add `encounter_tokens` JSONField to ActiveView model in terminal/models.py:
   - `encounter_tokens = models.JSONField(default=dict, blank=True, help_text='Map of token_id -> token data for encounter tokens')`
   - Place after `encounter_door_status` field

2. Run `python manage.py makemigrations terminal && python manage.py migrate`

3. Update `get_active_view_json` in terminal/views.py to include encounter_tokens in the response:
   - Add `'encounter_tokens': active_view.encounter_tokens or {}` to the response dict (near encounter_room_visibility)

4. Add token CRUD view functions to terminal/views.py (follow existing encounter API patterns like api_encounter_toggle_room):

   a. `api_encounter_place_token(request)` - POST: accepts JSON body with `type` (player|npc|creature|object), `name`, `x` (int grid coord), `y` (int grid coord), optional `image_url`, optional `room_id`. Generates UUID via `uuid.uuid4().hex[:8]` as token_id. Validates: type is valid enum, x/y are ints. Stores in `active_view.encounter_tokens[token_id]` as dict with keys: type, name, x, y, status (empty list), image_url (or ''), room_id (or ''). Returns `{success: true, token_id, tokens: active_view.encounter_tokens}`.

   b. `api_encounter_move_token(request)` - POST: accepts `token_id`, `x`, `y`, optional `room_id`. Validates token exists. Updates x, y, room_id. Returns `{success: true, token_id, tokens}`.

   c. `api_encounter_remove_token(request)` - POST: accepts `token_id`. Removes from dict. Returns `{success: true, tokens}`.

   d. `api_encounter_update_token_status(request)` - POST: accepts `token_id`, `status` (list of strings like ["wounded", "panicked"]). Validates token exists. Replaces status list. Returns `{success: true, token_id, tokens}`.

   e. `api_encounter_clear_tokens(request)` - POST: clears all tokens (`active_view.encounter_tokens = {}`). Returns `{success: true, tokens: {}}`.

   All endpoints: use `@csrf_exempt`, parse JSON body via `json.loads(request.body)`, get `ActiveView.get_current()`, save after changes.

5. Add `api_encounter_token_images(request)` - GET: Lists available token images from campaign data directories. Use DataLoader to:
   - Load crew roster (`load_crew()`), extract `portrait` field from each crew member
   - Load NPC roster (`load_npcs()`), extract `portrait` field from each NPC
   - Also scan `data/campaign/NPCs/images/` directory for any image files (png, jpg, jpeg, webp)
   - Return `{images: [{id, name, type, url, source}]}` where:
     - For crew: `{id: crew_id, name: crew_name, type: 'player', url: portrait_path, source: 'crew'}`
     - For NPCs: `{id: npc_id, name: npc_name, type: 'npc', url: portrait_path, source: 'npc'}`
     - For loose images: `{id: filename, name: filename_without_ext, type: 'creature', url: path, source: 'images'}`

6. Add URL patterns to terminal/urls.py (in the Encounter Map API section):
   ```
   path('api/gm/encounter/place-token/', views.api_encounter_place_token, name='encounter_place_token'),
   path('api/gm/encounter/move-token/', views.api_encounter_move_token, name='encounter_move_token'),
   path('api/gm/encounter/remove-token/', views.api_encounter_remove_token, name='encounter_remove_token'),
   path('api/gm/encounter/update-token-status/', views.api_encounter_update_token_status, name='encounter_update_token_status'),
   path('api/gm/encounter/clear-tokens/', views.api_encounter_clear_tokens, name='encounter_clear_tokens'),
   path('api/gm/encounter/token-images/', views.api_encounter_token_images, name='encounter_token_images'),
   ```
  </action>
  <verify>
    Run `python manage.py migrate --check` (no pending migrations).
    Run `python manage.py shell -c "from terminal.models import ActiveView; av = ActiveView.get_current(); print(type(av.encounter_tokens))"` - should print `<class 'dict'>`.
    Run `curl -s http://127.0.0.1:8000/api/active-view/ | python -m json.tool | grep encounter_tokens` - should show empty dict.
    Run `npm run typecheck` after Task 2 completes.
  </verify>
  <done>
    ActiveView has encounter_tokens JSONField. Six API endpoints respond correctly. Active view response includes encounter_tokens. Token images endpoint lists crew and NPC portraits.
  </done>
</task>

<task type="auto">
  <name>Task 2: TypeScript token types and API client functions</name>
  <files>
    src/types/encounterMap.ts
    src/services/encounterApi.ts
  </files>
  <action>
1. Add token type definitions to src/types/encounterMap.ts (at the top, after existing imports/types):

   ```typescript
   // Token types for encounter map tokens
   export type TokenType = 'player' | 'npc' | 'creature' | 'object';
   export type TokenStatus = 'wounded' | 'dead' | 'panicked' | 'stunned' | 'hidden';

   export interface TokenData {
     type: TokenType;
     x: number;
     y: number;
     name: string;
     status: TokenStatus[];
     image_url: string;
     room_id: string;
   }

   export interface TokenState {
     [tokenId: string]: TokenData;
   }

   // Token image available for selection in GM gallery
   export interface TokenImage {
     id: string;
     name: string;
     type: TokenType;
     url: string;
     source: 'crew' | 'npc' | 'images';
   }
   ```

2. Add token API client functions to src/services/encounterApi.ts:

   ```typescript
   interface TokenResponse {
     success: boolean;
     token_id?: string;
     tokens: TokenState;
   }

   interface TokenImagesResponse {
     images: TokenImage[];
   }

   async function placeToken(
     type: TokenType,
     name: string,
     x: number,
     y: number,
     imageUrl?: string,
     roomId?: string
   ): Promise<TokenResponse> {
     const response = await api.post<TokenResponse>('/gm/encounter/place-token/', {
       type, name, x, y,
       image_url: imageUrl || '',
       room_id: roomId || '',
     });
     return response.data;
   }

   async function moveToken(tokenId: string, x: number, y: number, roomId?: string): Promise<TokenResponse> {
     const response = await api.post<TokenResponse>('/gm/encounter/move-token/', {
       token_id: tokenId, x, y, room_id: roomId || '',
     });
     return response.data;
   }

   async function removeToken(tokenId: string): Promise<TokenResponse> {
     const response = await api.post<TokenResponse>('/gm/encounter/remove-token/', {
       token_id: tokenId,
     });
     return response.data;
   }

   async function updateTokenStatus(tokenId: string, status: TokenStatus[]): Promise<TokenResponse> {
     const response = await api.post<TokenResponse>('/gm/encounter/update-token-status/', {
       token_id: tokenId, status,
     });
     return response.data;
   }

   async function clearAllTokens(): Promise<TokenResponse> {
     const response = await api.post<TokenResponse>('/gm/encounter/clear-tokens/', {});
     return response.data;
   }

   async function getTokenImages(): Promise<TokenImage[]> {
     const response = await api.get<TokenImagesResponse>('/gm/encounter/token-images/');
     return response.data.images;
   }
   ```

   Add all six functions to the `encounterApi` export object.

   Add `TokenState`, `TokenData`, `TokenType`, `TokenStatus`, `TokenImage` to the imports from `@/types/encounterMap`.
  </action>
  <verify>
    Run `npm run typecheck` - no type errors.
  </verify>
  <done>
    TokenData, TokenType, TokenStatus, TokenState, TokenImage types defined. Six API client functions (placeToken, moveToken, removeToken, updateTokenStatus, clearAllTokens, getTokenImages) exported from encounterApi.
  </done>
</task>

</tasks>

<verification>
1. `python manage.py migrate --check` passes (no pending migrations)
2. `npm run typecheck` passes (no type errors)
3. Active view API response includes `encounter_tokens` field
4. Token CRUD operations work via curl/API calls
5. Token images endpoint returns crew and NPC portrait listings
</verification>

<success_criteria>
- ActiveView model has encounter_tokens JSONField with migration applied
- Six API endpoints (place, move, remove, update-status, clear, token-images) respond correctly
- Active view JSON response includes encounter_tokens for player polling
- TypeScript types match backend data structure
- API client functions typed and exported
</success_criteria>

<output>
After completion, create `.planning/phases/03-encounter-tokens/03-01-SUMMARY.md`
</output>
