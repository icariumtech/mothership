---
phase: 03-encounter-tokens
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/components/gm/TokenPalette.tsx
  - src/components/gm/TokenImageGallery.tsx
  - src/components/gm/EncounterPanel.tsx
  - src/components/domain/encounter/TokenLayer.tsx
  - src/components/domain/encounter/Token.tsx
  - src/components/domain/encounter/EncounterMapRenderer.tsx
  - src/components/gm/MapPreview.tsx
  - src/entries/GMConsole.tsx
autonomous: true

must_haves:
  truths:
    - "GM can drag a token from the palette onto the encounter map to place it"
    - "Palette shows pre-configured templates from crew roster and NPCs at current location"
    - "Palette has custom token option for ad-hoc entries"
    - "GM selects token image from gallery of available images when creating tokens"
    - "Tokens snap to grid cells on placement and movement"
    - "Two tokens cannot occupy the same grid cell (overlap prevention)"
    - "Tokens can only be placed in revealed rooms"
    - "GM can drag-to-move existing tokens with snap-to-grid"
    - "Token template stays selected after placement for duplicates"
    - "Clear All Tokens button with confirmation prompt"
    - "GM inline popup has status toggles and remove button that call APIs"
  artifacts:
    - path: "src/components/gm/TokenPalette.tsx"
      provides: "Token palette with templates, custom token, drag source"
      contains: "TokenPalette"
    - path: "src/components/gm/TokenImageGallery.tsx"
      provides: "Image gallery modal for selecting token images"
      contains: "TokenImageGallery"
    - path: "src/components/gm/EncounterPanel.tsx"
      provides: "Extended with TokenPalette and token management"
      contains: "TokenPalette"
    - path: "src/components/gm/MapPreview.tsx"
      provides: "Extended with token rendering and drop target for placement"
      contains: "tokens"
  key_links:
    - from: "src/components/gm/TokenPalette.tsx"
      to: "src/services/encounterApi.ts"
      via: "API calls for placeToken, getTokenImages"
      pattern: "encounterApi\\.placeToken"
    - from: "src/components/gm/MapPreview.tsx"
      to: "src/components/domain/encounter/TokenLayer.tsx"
      via: "Renders tokens on GM preview map"
      pattern: "<TokenLayer"
    - from: "src/components/gm/EncounterPanel.tsx"
      to: "src/services/encounterApi.ts"
      via: "API calls for clearAllTokens, moveToken, removeToken, updateTokenStatus"
      pattern: "encounterApi"
    - from: "src/components/domain/encounter/Token.tsx"
      to: "src/components/domain/encounter/TokenLayer.tsx"
      via: "Drag-to-move with SVG coordinate transforms and grid snapping"
      pattern: "onMouseDown|onMouseMove"
---

<objective>
GM token controls: palette with templates and image gallery, drag-from-palette placement, drag-to-move repositioning, grid snapping, overlap prevention, status management via inline popup, and clear-all functionality.

Purpose: Give the GM full token management during encounters. Per user decisions: drag from palette to map, pre-configured templates from crew/NPCs, image gallery selection, token stays selected for duplicates, snap to grid, overlap prevention, tokens only in revealed rooms, inline popup with status toggles and remove, clear all with confirmation.

Output: TokenPalette, TokenImageGallery components in GM console, MapPreview extended as drop target, Token drag-to-move behavior, full GM encounter token workflow.
</objective>

<execution_context>
@/home/gjohnson/.claude/get-shit-done/workflows/execute-plan.md
@/home/gjohnson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-encounter-tokens/03-CONTEXT.md
@.planning/phases/03-encounter-tokens/03-RESEARCH.md
@.planning/phases/03-encounter-tokens/03-01-SUMMARY.md
@.planning/phases/03-encounter-tokens/03-02-SUMMARY.md
@src/components/gm/EncounterPanel.tsx
@src/components/gm/MapPreview.tsx
@src/components/domain/encounter/Token.tsx
@src/components/domain/encounter/TokenLayer.tsx
@src/components/domain/encounter/EncounterMapRenderer.tsx
@src/services/encounterApi.ts
@src/types/encounterMap.ts
@src/entries/GMConsole.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: TokenPalette with templates, custom tokens, image gallery, and drag source</name>
  <files>
    src/components/gm/TokenPalette.tsx
    src/components/gm/TokenImageGallery.tsx
  </files>
  <action>
1. Create `src/components/gm/TokenImageGallery.tsx`:
   - Props: `visible: boolean`, `onSelect: (image: TokenImage) => void`, `onClose: () => void`
   - On mount (when visible), fetch images via `encounterApi.getTokenImages()`
   - Display as Ant Design Modal with grid of image thumbnails
   - Group images by source: "CREW", "NPCs", "OTHER IMAGES"
   - Each thumbnail: 48x48px circular clip (matching token appearance), with name below
   - Click a thumbnail to call `onSelect(image)` and close gallery
   - Style: dark background matching terminal aesthetic, teal section headers

2. Create `src/components/gm/TokenPalette.tsx`:
   - Props: `activeView: ActiveView | null`, `tokens: TokenState`, `onTokensChange: (tokens: TokenState) => void`, `onViewUpdate: () => void`, `mapData: EncounterMapData | null`, `roomVisibility: RoomVisibilityState`
   - State: `selectedTemplate: { type, name, imageUrl } | null`, `customName: string`, `customType: TokenType`, `galleryVisible: boolean`
   - Sections in the palette:

   **a. Pre-configured Templates (per user decision):**
   - Auto-populate from campaign data:
     - Fetch crew and NPCs via `encounterApi.getTokenImages()` on mount
     - Crew members -> player-type templates with their portrait
     - NPCs -> npc-type templates with their portrait
   - Render each template as a small draggable card: circular thumbnail (32px), name, type badge
   - Card has `draggable="true"` with `onDragStart` setting dataTransfer with template data
   - Clicking a template selects it (highlighted border), stays selected after placement (per user decision)
   - Selected template can also be placed by clicking on the map preview (alternative to drag)

   **b. Custom Token (per user decision):**
   - Input field for custom name
   - Type selector (4 buttons: Player, NPC, Creature, Object)
   - "Select Image" button that opens TokenImageGallery
   - Shows selected image thumbnail or placeholder
   - "Create" button that sets this as the selected template
   - Custom tokens are also draggable to map

   **c. Clear All Tokens (per user decision):**
   - "CLEAR ALL TOKENS" button, styled as danger/warning
   - On click: show Ant Design `Modal.confirm` with warning message "Remove all tokens from the encounter map?"
   - On confirm: call `encounterApi.clearAllTokens()`, update local token state

   - When a template is selected, show visual indicator (amber border highlight)
   - Template stays selected after placement (per user decision) so GM can place duplicates

3. Drag data format (for palette -> map drag):
   - On dragStart: `e.dataTransfer.setData('application/json', JSON.stringify({ type, name, imageUrl }))`
   - Set `e.dataTransfer.effectAllowed = 'copy'`
   - Create a small drag image preview (optional: use a 32px canvas with the token image)
  </action>
  <verify>
    Run `npm run typecheck` - no type errors.
  </verify>
  <done>
    TokenPalette renders crew/NPC templates, custom token creator, and clear-all button. Templates are draggable. Image gallery shows available token images. Selected template persists after placement.
  </done>
</task>

<task type="auto">
  <name>Task 2: MapPreview as drop target, drag-to-move on tokens, and EncounterPanel integration</name>
  <files>
    src/components/gm/MapPreview.tsx
    src/components/gm/EncounterPanel.tsx
    src/components/domain/encounter/Token.tsx
    src/components/domain/encounter/TokenLayer.tsx
    src/components/domain/encounter/EncounterMapRenderer.tsx
    src/entries/GMConsole.tsx
  </files>
  <action>
1. Extend MapPreview.tsx to be a drop target for token placement:
   - Add props: `tokens?: TokenState`, `isGM?: boolean`, `onTokenPlace?: (type, name, x, y, imageUrl, roomId) => void`, `onTokenMove?: (id, x, y) => void`, `onTokenRemove?: (id) => void`, `onTokenStatusToggle?: (id, status) => void`, `roomVisibility?: RoomVisibilityState`
   - Add `onDragOver` handler: `e.preventDefault()` to allow drop, set `e.dataTransfer.dropEffect = 'copy'`
   - Add `onDrop` handler:
     - Parse template data from `e.dataTransfer.getData('application/json')`
     - Convert drop position to SVG coordinates using the SVG element's coordinate system:
       - Get the SVG element, use `createSVGPoint()` + `getScreenCTM().inverse()` to convert screen coords to SVG space
       - Account for pan/zoom state
     - Snap to grid: `Math.floor(svgX / unitSize)`, `Math.floor(svgY / unitSize)`
     - **Overlap prevention (per user decision):** Check if any existing token occupies the target grid cell. If occupied, do not place (show brief message or visual feedback).
     - **Revealed rooms only (per user decision):** Determine which room contains the target cell. Check room boundaries from mapData.rooms â€” find the room whose bounds (x, y, width, height) contain the target cell. If no room contains the cell, or if the room is not revealed (roomVisibility[roomId] === false), reject the placement.
     - If valid: call `onTokenPlace(type, name, gridX, gridY, imageUrl, roomId)`
   - Pass tokens and handlers through to EncounterMapRenderer so tokens render on the GM preview
   - EncounterMapRenderer already accepts these props (from Plan 02), just wire them through

2. Implement drag-to-move for existing tokens on the GM map:
   - In Token.tsx: already has `onDragStart` prop from Plan 02
   - In TokenLayer.tsx: implement the drag-to-move behavior:
     - Track drag state: `isDragging`, `dragTokenId`, `dragPosition` (current mouse position in SVG coords)
     - On token drag start: set `isDragging = true`, `dragTokenId = id`
     - On mouse move (attached to window when dragging): convert mouse position to SVG coords, calculate snapped grid position, show ghost token at snapped position
     - On mouse up: finalize position, check overlap prevention and revealed-room constraints same as placement
     - Call `onTokenMove(tokenId, newGridX, newGridY)` which triggers API call
     - Debounce the API call: only call on mouseup (not during drag), so we send one API request per drag operation
   - Use `svg.createSVGPoint()` + `getScreenCTM().inverse()` for coordinate transforms (per research anti-pattern #1)
   - Call `e.stopPropagation()` on token mousedown to prevent map panning (per research anti-pattern #2)

3. Wire up GM inline popup actions:
   - In EncounterPanel or wherever GM map is rendered, the `onTokenRemove` handler should:
     - Call `encounterApi.removeToken(tokenId)`
     - Update local token state from response
     - Call `onViewUpdate()` to trigger re-poll
   - The `onTokenStatusToggle` handler should:
     - Toggle the status in the token's status array (add if missing, remove if present)
     - Call `encounterApi.updateTokenStatus(tokenId, newStatusArray)`
     - Update local token state from response
     - Call `onViewUpdate()`
   - The `onTokenMove` handler should:
     - Call `encounterApi.moveToken(tokenId, x, y)`
     - Update local token state from response
     - Call `onViewUpdate()`

4. Integrate TokenPalette into EncounterPanel:
   - Import TokenPalette
   - Add it as a new Card section in EncounterPanel, between MAP PREVIEW and ROOM VISIBILITY:
     ```tsx
     <Card
       size="small"
       title={<Text style={{ color: '#5a7a7a' }}>TOKENS</Text>}
       style={{ marginBottom: 16, background: '#1a1a1a' }}
       bodyStyle={{ padding: 12 }}
     >
       <TokenPalette
         activeView={activeView}
         tokens={encounterTokens}
         onTokensChange={setEncounterTokens}
         onViewUpdate={onViewUpdate}
         mapData={currentDeckMapData}
         roomVisibility={roomVisibility}
       />
     </Card>
     ```
   - Add `encounterTokens` state to EncounterPanel
   - Load tokens from activeView.encounter_tokens and sync on activeView changes
   - Pass token handlers (place, move, remove, status) to MapPreview
   - The `onTokenPlace` handler calls `encounterApi.placeToken()`, updates local state, calls `onViewUpdate()`

5. Check GMConsole.tsx to ensure it passes the right props. The EncounterPanel already receives `activeView` and `onViewUpdate`. Make sure token state flows correctly: EncounterPanel manages local token state, makes API calls, and calls `onViewUpdate` so the player terminal picks up changes via polling.
  </action>
  <verify>
    Run `npm run typecheck` - no type errors.
    Run `npm run build` - no build errors.
  </verify>
  <done>
    GM can drag tokens from palette onto map preview with grid snapping. Overlap prevention and revealed-room constraints enforced. GM can drag-to-move existing tokens. Inline popup status toggles and remove button call APIs. Clear all tokens works with confirmation. Token state syncs to player terminal via polling.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. `npm run build` succeeds
3. GM can drag a crew template from palette onto the map preview
4. Token snaps to grid cell center on drop
5. Placing on occupied cell is rejected
6. Placing on unrevealed room is rejected
7. GM can drag-move an existing token to a new cell
8. Clicking placed token opens popup with status toggles and remove
9. Toggling wounded/panicked/dead status reflects on token appearance
10. Remove button removes token from map
11. Clear All Tokens removes all tokens after confirmation
12. Template stays selected after placement (can place duplicates)
13. Player terminal shows token changes within 2-second polling interval
</verification>

<success_criteria>
- Drag from palette to map places token at grid-snapped position
- Pre-configured templates auto-populate from crew roster and NPCs
- Custom token option allows ad-hoc entries with image gallery selection
- Tokens snap to grid, overlap prevented, only placed in revealed rooms
- Drag-to-move repositions tokens with grid snapping
- Inline popup provides status toggles and remove button (calling APIs)
- Clear All Tokens with confirmation prompt
- Template persists after placement for duplicate creation
- Player terminal receives all changes via existing polling
</success_criteria>

<output>
After completion, create `.planning/phases/03-encounter-tokens/03-03-SUMMARY.md`
</output>
