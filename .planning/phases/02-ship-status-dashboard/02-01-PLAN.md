---
phase: 02-ship-status-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - data/campaign/ship.yaml
  - terminal/data_loader.py
  - terminal/views.py
  - terminal/urls.py
  - terminal/models.py
  - terminal/templates/terminal/shared_console_react.html
  - src/types/shipStatus.ts
autonomous: true

must_haves:
  truths:
    - "Ship status data loads from data/campaign/ship.yaml"
    - "API endpoint returns ship status JSON with runtime overrides applied"
    - "GM can POST system state changes that persist in ActiveView"
    - "window.INITIAL_DATA.shipStatus is available in browser"
    - "TypeScript types define ShipStatusData interface"
  artifacts:
    - path: "data/campaign/ship.yaml"
      provides: "Sample ship data with name, class, hull, armor, crew, 4 systems"
      contains: "USCSS Morrigan"
    - path: "terminal/data_loader.py"
      provides: "load_ship_status() method"
      contains: "def load_ship_status"
    - path: "terminal/views.py"
      provides: "GET /api/ship-status/ and POST /api/gm/ship-status/toggle/"
      contains: "def api_ship_status"
    - path: "terminal/models.py"
      provides: "ship_system_overrides JSONField on ActiveView"
      contains: "ship_system_overrides"
    - path: "src/types/shipStatus.ts"
      provides: "ShipStatusData and SystemData TypeScript interfaces"
      exports: ["ShipStatusData", "SystemData", "SystemStatus"]
  key_links:
    - from: "terminal/views.py"
      to: "terminal/data_loader.py"
      via: "loader.load_ship_status()"
      pattern: "load_ship_status"
    - from: "terminal/views.py"
      to: "terminal/models.py"
      via: "ActiveView.ship_system_overrides merging"
      pattern: "ship_system_overrides"
    - from: "terminal/templates/terminal/shared_console_react.html"
      to: "terminal/views.py"
      via: "ship_status_json template variable"
      pattern: "shipStatus"
---

<objective>
Create the backend data pipeline for ship status: YAML data file, DataLoader method, API endpoints (read + write), ActiveView runtime overrides, TypeScript types, and INITIAL_DATA wiring.

Purpose: Establishes the data foundation that both the terminal STATUS tab (Plan 02) and GM Console controls (Plan 03) depend on.
Output: Working API returning ship status JSON, GM toggle endpoint, TypeScript types, sample ship data.
</objective>

<execution_context>
@/home/gjohnson/.claude/get-shit-done/workflows/execute-plan.md
@/home/gjohnson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-campaign-logs-tab/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Ship data file, DataLoader, TypeScript types</name>
  <files>
    data/campaign/ship.yaml
    terminal/data_loader.py
    src/types/shipStatus.ts
  </files>
  <action>
1. Create `data/campaign/ship.yaml` with this structure:
```yaml
ship:
  name: "USCSS Morrigan"
  class: "Hargrave-Class Light Freighter"
  crew_count: 7
  crew_capacity: 12
  hull:
    current: 45
    max: 60
  armor:
    current: 8
    max: 12
  systems:
    life_support:
      status: "ONLINE"
      condition: 100
      info: "O2 levels nominal"
    engines:
      status: "STRESSED"
      condition: 72
      info: "Coolant pressure low"
    weapons:
      status: "ONLINE"
      condition: 100
      info: "Defense grid active"
    comms:
      status: "DAMAGED"
      condition: 45
      info: "Long-range offline"
```

2. Add `load_ship_status()` method to DataLoader in `terminal/data_loader.py`:
```python
def load_ship_status(self):
    """Load ship status from data/campaign/ship.yaml."""
    ship_file = self.data_dir / "campaign" / "ship.yaml"
    if not ship_file.exists():
        return None
    with open(ship_file, 'r') as f:
        ship_data = yaml.safe_load(f)
    return ship_data
```
Follow the same pattern as `load_crew()` — simple file load, return parsed YAML.

3. Create `src/types/shipStatus.ts`:
```typescript
export type SystemStatus = 'ONLINE' | 'STRESSED' | 'DAMAGED' | 'CRITICAL' | 'OFFLINE';

export interface SystemData {
  status: SystemStatus;
  condition: number;
  info?: string;
}

export interface ShipStatusData {
  ship: {
    name: string;
    class: string;
    crew_count: number;
    crew_capacity: number;
    hull: { current: number; max: number };
    armor: { current: number; max: number };
    systems: {
      life_support: SystemData;
      engines: SystemData;
      weapons: SystemData;
      comms: SystemData;
    };
  };
}
```
  </action>
  <verify>
Run: `python3 -c "from terminal.data_loader import DataLoader; loader = DataLoader(); data = loader.load_ship_status(); print(data['ship']['name'])"` — should print "USCSS Morrigan".
Run: `npx tsc --noEmit src/types/shipStatus.ts` — no errors.
  </verify>
  <done>ship.yaml exists with all required fields, DataLoader.load_ship_status() returns parsed data, TypeScript interfaces compile cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: ActiveView model field, API endpoints, INITIAL_DATA wiring</name>
  <files>
    terminal/models.py
    terminal/views.py
    terminal/urls.py
    terminal/templates/terminal/shared_console_react.html
  </files>
  <action>
1. Add `ship_system_overrides` JSONField to ActiveView model in `terminal/models.py`:
```python
ship_system_overrides = models.JSONField(
    default=dict,
    blank=True,
    help_text='Runtime overrides for ship system states {system_name: {status, condition, info}}'
)
```
Place it after the encounter fields. Then run: `python manage.py makemigrations terminal && python manage.py migrate`

2. Add two API endpoints in `terminal/views.py`:

**GET endpoint** — `api_ship_status(request)`:
- Load ship data via `DataLoader().load_ship_status()`
- Load ActiveView and merge `ship_system_overrides` into ship data (overrides take precedence over YAML defaults)
- Return JsonResponse with merged ship data
- Public endpoint (no @login_required) — terminal needs to read it

**POST endpoint** — `api_ship_toggle_system(request)` (GM only, @login_required):
- Accept JSON body: `{ system: string, status: string, condition?: number, info?: string }`
- Validate system name is one of: life_support, engines, weapons, comms
- Validate status is one of: ONLINE, STRESSED, DAMAGED, CRITICAL, OFFLINE
- Store override in ActiveView.ship_system_overrides
- Return success JSON

Override merging logic in GET endpoint:
```python
ship_data = loader.load_ship_status()
if ship_data and ship_data.get('ship'):
    overrides = active_view.ship_system_overrides or {}
    for system_name, override in overrides.items():
        if system_name in ship_data['ship'].get('systems', {}):
            ship_data['ship']['systems'][system_name].update(override)
```

3. Add URL routes in `terminal/urls.py`:
```python
path('api/ship-status/', views.api_ship_status, name='ship_status_api'),
path('api/gm/ship-status/toggle/', views.api_ship_toggle_system, name='ship_toggle_system'),
```

4. Wire ship data to INITIAL_DATA in `display_view_react()` in views.py:
- After loading sessions, add: load ship status and merge overrides, serialize to JSON
- Add `ship_status_json` to template context

5. Update `shared_console_react.html` to include ship data:
- Add `shipStatus: {{ ship_status_json|safe|default:'null' }}` to window.INITIAL_DATA
  </action>
  <verify>
Run: `python manage.py migrate --check` — no pending migrations.
Run: `python manage.py runserver --noreload &` then `curl -s http://127.0.0.1:8000/api/ship-status/ | python3 -m json.tool` — should return ship JSON with name, hull, systems.
Run: `npx tsc --noEmit` — no TypeScript errors.
  </verify>
  <done>ActiveView has ship_system_overrides field. GET /api/ship-status/ returns merged ship data. POST /api/gm/ship-status/toggle/ updates system state. window.INITIAL_DATA.shipStatus available in template. Migration applied.</done>
</task>

</tasks>

<verification>
1. `python3 -c "from terminal.data_loader import DataLoader; d = DataLoader().load_ship_status(); print(d['ship']['name'], len(d['ship']['systems']))"` prints "USCSS Morrigan 4"
2. `curl -s http://127.0.0.1:8000/api/ship-status/` returns valid JSON with ship.name, ship.hull, ship.systems
3. `npx tsc --noEmit` passes with no errors
4. Ship data appears in window.INITIAL_DATA.shipStatus when viewing terminal page source
</verification>

<success_criteria>
- ship.yaml file contains ship identity, hull/armor, and 4 systems with status/condition/info
- DataLoader.load_ship_status() returns parsed ship data
- ShipStatusData TypeScript interface matches YAML schema
- GET /api/ship-status/ merges YAML defaults with ActiveView runtime overrides
- POST /api/gm/ship-status/toggle/ stores system state overrides in ActiveView
- window.INITIAL_DATA.shipStatus is available to React components
- Database migration applied successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02-ship-status-dashboard/02-01-SUMMARY.md`
</output>
