---
phase: 04-npc-portrait-system
plan: 04
type: execute
wave: 3
depends_on:
  - "04-03"
files_modified: []
autonomous: false
requirements:
  - PORT-01
  - PORT-02
  - PORT-03
  - PORT-04
  - PORT-05

must_haves:
  truths:
    - "GM clicks SHOW on an NPC in encounter panel and portrait appears on terminal within polling cycle (≤2 seconds)"
    - "Portrait reveals with flicker then scan-wipe then typewriter name — in that order, total ~1.5 seconds"
    - "CRT scanlines and chamfered border are visually present on the portrait card"
    - "GM clicks SHOW on a second NPC while first is displayed — both portraits tile side by side"
    - "GM clicks DISMISS — portrait fades out smoothly before disappearing"
    - "Switching encounter location clears all portraits"
  artifacts:
    - path: "src/components/domain/encounter/NPCPortraitOverlay.tsx"
      provides: "Running portrait overlay"
    - path: "src/components/domain/encounter/NPCPortraitCard.tsx"
      provides: "Animated portrait card"
  key_links:
    - from: "GM console SHOW button"
      to: "terminal portrait overlay"
      via: "encounterApi.togglePortrait → Django API → poll response → NPCPortraitOverlay"
      pattern: "encounter_active_portraits"
---

<objective>
Human verification that the NPC portrait system works end-to-end: GM triggers portraits, terminal shows CRT reveal animations, multiple portraits tile correctly, dismissal is smooth.

Purpose: Visual and functional verification cannot be automated — the animation quality, visual styling, and GM→terminal flow require human eyes and interaction to confirm.

Output: Phase 4 verified complete or issues identified for gap closure.
</objective>

<execution_context>
@/home/gjohnson/.claude/get-shit-done/workflows/execute-plan.md
@/home/gjohnson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/04-npc-portrait-system/04-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify NPC portrait system end-to-end</name>
  <action>Human verification — see how-to-verify below</action>
  <verify>Human confirms all 6 test scenarios pass</verify>
  <done>All 6 tests pass: GM trigger, animation sequence, multiple portraits, dismiss, fallback, location reset</done>
  <what-built>
    Full NPC portrait system:
    - GM console EncounterPanel shows NPC PORTRAITS section with SHOW/DISMISS toggle buttons (contextual to ENCOUNTER view)
    - Player terminal NPCPortraitOverlay renders centered portrait cards when encounter_active_portraits is non-empty
    - Each NPCPortraitCard plays: CRT flicker → scan-wipe top-to-bottom → typewriter name reveal
    - Multiple portraits tile side by side horizontally
    - Portrait removal plays fade-out animation before unmounting
    - Chamfered Panel border and CRT scanline overlay visible on each card
    - Switching encounter location clears all portraits
  </what-built>
  <how-to-verify>
    **Setup:** Start the Django server and Vite dev server. Open two browser windows:
    - Window 1: http://127.0.0.1:8000/gmconsole/ (GM Console — log in if needed)
    - Window 2: http://127.0.0.1:8000/terminal/ (Player Terminal)

    **Test 1 — GM console shows NPC PORTRAITS section:**
    1. In GM Console, switch to an ENCOUNTER view location (e.g., click "DISPLAY" on a station/ship)
    2. Look in the right-side encounter panel — scroll down below ROOM VISIBILITY
    3. Confirm "NPC PORTRAITS" section is visible with NPC names and SHOW/DISMISS buttons
    4. Expected: Section shows Dr. Lucia Vance, Ewan McGregor, Dr. Yuki Tanaka, Captain Dex Harrow with SHOW buttons

    **Test 2 — Single portrait reveal animation:**
    1. In GM Console, click SHOW on "Dr. Lucia Vance"
    2. On player terminal (Window 2), within 2 seconds, a portrait overlay should appear
    3. Verify animation sequence:
       a. Brief flicker (opacity pulses, ~280ms)
       b. Image wipes in from top to bottom (~650ms)
       c. Image fully visible, stabilizes briefly
       d. Name "Dr. Lucia Vance" types out letter by letter below the image
    4. Verify visual styling:
       - Dimmed background behind portrait (but not fully black — encounter map slightly visible)
       - CRT scanlines visible over the portrait image
       - Vignette darkening at portrait edges
       - Chamfered angular border around the portrait panel
       - Amber/teal colored name text

    **Test 3 — Multiple portraits side by side:**
    1. With Dr. Lucia Vance already showing, click SHOW on "Ewan McGregor" in GM console
    2. On player terminal, second portrait should appear alongside the first (horizontal tiling)
    3. Verify: both portraits are visible side by side, no overlap

    **Test 4 — Dismiss portrait:**
    1. Click DISMISS on "Dr. Lucia Vance" in GM console
    2. On player terminal, that portrait should fade out smoothly (not snap away)
    3. Remaining portrait ("Ewan McGregor") stays visible and repositions
    4. Click DISMISS on "Ewan McGregor" — overlay fades out, encounter map fully visible again

    **Test 5 — NPC without portrait image:**
    1. Click SHOW on "Dr. Yuki Tanaka" (has no portrait in npcs.yaml)
    2. Verify: placeholder (?) or graceful fallback shown, name still types out

    **Test 6 — Location switch clears portraits:**
    1. Show a portrait (SHOW Dr. Lucia Vance)
    2. In GM console, switch to a different ENCOUNTER location
    3. Verify: portrait overlay clears on the terminal (encounter_active_portraits reset to [])

    **Report any issues found.**
  </how-to-verify>
  <resume-signal>Type "approved" if all 6 tests pass. Or describe which tests failed and what was observed (animation skipped, styling wrong, buttons missing, etc.).</resume-signal>
</task>

</tasks>

<verification>
Human confirms all 6 test scenarios pass:
1. NPC PORTRAITS section visible in GM console encounter panel
2. Single portrait reveal plays flicker → wipe → typewriter sequence
3. Multiple portraits tile horizontally
4. Dismiss triggers smooth fade-out
5. NPCs without portrait images show graceful fallback
6. Location switch clears all portraits
</verification>

<success_criteria>
All 6 verification tests pass. Phase 4 requirements PORT-01 through PORT-05 are visually confirmed working.
</success_criteria>

<output>
After checkpoint approved, create `.planning/phases/04-npc-portrait-system/04-04-SUMMARY.md` noting verification results and any observations about the animation quality or visual polish.
</output>
