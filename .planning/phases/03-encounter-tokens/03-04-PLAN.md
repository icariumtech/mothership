---
phase: 03-encounter-tokens
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/gm/TokenPalette.tsx
  - src/components/gm/MapPreview.tsx
  - src/components/domain/encounter/TokenLayer.tsx
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Drag preview from token palette shows token-sized circular image, not full-size portrait"
    - "Custom tokens created via palette appear in template grid and can be dragged onto map"
    - "GM console token labels show initial by default with readable text color (not black)"
    - "Tokens in rooms toggled to unrevealed are hidden from player view"
    - "Clicking a token in GM console shows popup with status toggles and remove button"
  artifacts:
    - path: "src/components/gm/TokenPalette.tsx"
      provides: "Sized drag preview canvas, custom token in templates array"
    - path: "src/components/gm/MapPreview.tsx"
      provides: "CSS import for token styles, selectedTokenId state passed to TokenLayer"
    - path: "src/components/domain/encounter/TokenLayer.tsx"
      provides: "Strict room visibility filter (=== true)"
  key_links:
    - from: "src/components/gm/MapPreview.tsx"
      to: "src/components/domain/encounter/TokenLayer.tsx"
      via: "selectedTokenId and onTokenSelect props"
      pattern: "selectedTokenId.*onTokenSelect"
    - from: "src/components/domain/encounter/TokenLayer.tsx"
      to: "roomVisibility"
      via: "strict visibility check"
      pattern: "roomVisibility\\[.*\\] === true"
---

<objective>
Fix 5 UAT gaps from Phase 03 user acceptance testing (8 failed tests, 5 unique root causes).

Purpose: Close all remaining issues so encounter tokens work correctly for both GM and player views.
Output: Patched TokenPalette.tsx, MapPreview.tsx, and TokenLayer.tsx with all gaps resolved.
</objective>

<execution_context>
@/home/gjohnson/.claude/get-shit-done/workflows/execute-plan.md
@/home/gjohnson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-encounter-tokens/03-02-SUMMARY.md
@.planning/phases/03-encounter-tokens/03-03-SUMMARY.md
@.planning/phases/03-encounter-tokens/03-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix TokenPalette drag preview and custom token placement</name>
  <files>src/components/gm/TokenPalette.tsx</files>
  <action>
Two fixes in TokenPalette.tsx:

**Fix 1 - Drag preview too large (UAT test 2, cosmetic):**
In `handleDragStart` (around line 123-133), replace the raw `new Image()` approach with a canvas-based drag preview:
- Create a 40x40 `<canvas>` element (matches token visual size)
- Draw the template image scaled to fill the canvas with circular clipping:
  - `ctx.arc(20, 20, 20, 0, Math.PI * 2)` then `ctx.clip()`
  - `ctx.drawImage(img, 0, 0, 40, 40)`
- Pre-load images when templates load (store in a Map/ref keyed by imageUrl) so they are ready synchronously when drag starts
- Call `e.dataTransfer.setDragImage(canvas, 20, 20)` with center hotspot
- If image not yet loaded, fall back to a plain colored circle on canvas matching the token type color

**Fix 2 - Custom token not placeable (UAT test 4, major):**
In `handleCreateCustom` (around line 99-113), after creating the `customTemplate` object:
- Add the custom template to the `templates` state array: `setTemplates(prev => [...prev, customTemplate])`
- This makes the custom token appear in the template grid as a draggable card
- Keep the existing `setSelectedTemplate(customTemplate)` to auto-select it
- Clear the custom form fields after creation (customName, customImageUrl) so the form is ready for another custom token
  </action>
  <verify>
Run `npm run typecheck` from project root - 0 errors.
Grep TokenPalette.tsx for `canvas` and `setTemplates` to confirm both fixes present.
  </verify>
  <done>
Dragging a template from palette shows a small circular preview (not full-size portrait).
Custom tokens appear in the template grid after creation and can be dragged onto the map.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix MapPreview token popup, CSS import, and TokenLayer visibility filter</name>
  <files>src/components/gm/MapPreview.tsx, src/components/domain/encounter/TokenLayer.tsx</files>
  <action>
Three fixes across two files:

**Fix 1 - GM console missing token popup (UAT tests 11, 12, 13 - major):**
In MapPreview.tsx:
- Add `useState` for `selectedTokenId`: `const [selectedTokenId, setSelectedTokenId] = useState<string | null>(null)`
- Pass `selectedTokenId={selectedTokenId}` and `onTokenSelect={setSelectedTokenId}` props to the `<TokenLayer>` component (around line 652-663)
- This enables the TokenPopup to render in GM console with status toggles and remove button (TokenLayer and TokenPopup already support these props from Plan 03-02)

**Fix 2 - GM console token labels unreadable (UAT test 7, minor):**
In MapPreview.tsx:
- Add CSS import at top of file: `import '@/components/domain/encounter/EncounterMapRenderer.css'`
- This applies the token label styles (initial/full name toggle, text color) that are already defined in the stylesheet
- Without this import, SVG text defaults to black fill and both label variants show simultaneously

**Fix 3 - Tokens visible in hidden rooms on player view (UAT tests 9, 16 - major):**
In TokenLayer.tsx, in the visibility filter (around line 68):
- Change `return roomVisibility[token.room_id] !== false` to `return roomVisibility[token.room_id] === true`
- This requires EXPLICIT true for visibility instead of treating undefined/missing as visible
- When a room is hidden (not in roomVisibility or set to false), tokens in that room will now be hidden from players
- The GM view (isGM=true) is unaffected as it returns true on line 61 before reaching this check
  </action>
  <verify>
Run `npm run typecheck` from project root - 0 errors.
Run `npm run build` from project root - succeeds.
Grep MapPreview.tsx for `selectedTokenId` and `EncounterMapRenderer.css` to confirm fixes.
Grep TokenLayer.tsx for `=== true` to confirm visibility fix.
  </verify>
  <done>
Clicking a token in GM console shows popup with name, status toggles (wounded/panicked/stunned), and remove button.
Token labels in GM console show initial by default with readable text (not black).
Tokens in unrevealed rooms are hidden from player terminal view.
  </done>
</task>

</tasks>

<verification>
All 8 UAT failures resolved:
- Test 2: Drag preview shows token-sized circular image
- Test 4: Custom tokens appear in template grid and are placeable
- Test 7: GM console token labels readable with correct initial/hover behavior
- Test 9: Tokens hidden when room becomes unrevealed (GM still sees them)
- Test 11: GM console token click shows popup with full controls
- Test 12: Status toggle buttons work via popup
- Test 13: Remove button works via popup
- Test 16: Player view hides tokens when room is unrevealed

Run: `npm run typecheck && npm run build` - both pass.
</verification>

<success_criteria>
All 5 root causes patched. TypeScript compiles. Production build succeeds.
8 previously failing UAT tests now pass on manual re-test.
</success_criteria>

<output>
After completion, create `.planning/phases/03-encounter-tokens/03-04-SUMMARY.md`
</output>
