---
phase: 03-encounter-tokens
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/domain/encounter/TokenLayer.tsx
  - src/components/domain/encounter/Token.tsx
  - src/components/domain/encounter/TokenStatusOverlay.tsx
  - src/components/domain/encounter/EncounterMapRenderer.tsx
  - src/components/domain/encounter/EncounterMapRenderer.css
  - src/components/domain/encounter/EncounterMapDisplay.tsx
  - src/components/domain/encounter/EncounterView.tsx
  - src/entries/SharedConsole.tsx
autonomous: true

must_haves:
  truths:
    - "Tokens render as colored SVG circles on the encounter map grid"
    - "Token types are visually distinct (player=amber, npc=teal, creature=burgundy, object=dashed gray)"
    - "Token names display as text labels"
    - "Status indicators render on tokens (wounded=red dot, dead=X, panicked=dashed ring)"
    - "Tokens appear at correct grid cell positions"
    - "Player terminal shows tokens via polling (no drag capability)"
  artifacts:
    - path: "src/components/domain/encounter/TokenLayer.tsx"
      provides: "SVG group rendering all tokens"
      contains: "TokenLayer"
    - path: "src/components/domain/encounter/Token.tsx"
      provides: "Individual token SVG sprite with type styling"
      contains: "Token"
    - path: "src/components/domain/encounter/TokenStatusOverlay.tsx"
      provides: "Status indicator overlays (wounded, dead, panicked)"
      contains: "TokenStatusOverlay"
    - path: "src/components/domain/encounter/EncounterMapRenderer.css"
      provides: "Token CSS classes and status animations"
      contains: "encounter-map__token"
  key_links:
    - from: "src/entries/SharedConsole.tsx"
      to: "src/components/domain/encounter/EncounterView.tsx"
      via: "encounter_tokens prop from active view polling"
      pattern: "encounter_tokens"
    - from: "src/components/domain/encounter/EncounterMapRenderer.tsx"
      to: "src/components/domain/encounter/TokenLayer.tsx"
      via: "TokenLayer rendered as SVG group above rooms"
      pattern: "<TokenLayer"
    - from: "src/components/domain/encounter/Token.tsx"
      to: "src/components/domain/encounter/TokenStatusOverlay.tsx"
      via: "Status overlay rendered inside token group"
      pattern: "<TokenStatusOverlay"
---

<objective>
Frontend token rendering on encounter maps with visual type distinction and status indicators.

Purpose: Players see tokens on the encounter map during gameplay, with clear visual differentiation between token types and status conditions.
Output: TokenLayer, Token, and TokenStatusOverlay components integrated into the encounter map SVG, with tokens flowing from polling through to render.
</objective>

<execution_context>
@/home/gjohnson/.claude/get-shit-done/workflows/execute-plan.md
@/home/gjohnson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-encounter-tokens/03-RESEARCH.md
@.planning/phases/03-encounter-tokens/03-01-SUMMARY.md
@src/components/domain/encounter/EncounterMapRenderer.tsx
@src/components/domain/encounter/EncounterMapRenderer.css
@src/components/domain/encounter/EncounterMapDisplay.tsx
@src/components/domain/encounter/EncounterView.tsx
@src/entries/SharedConsole.tsx
@src/types/encounterMap.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Token SVG components (TokenLayer, Token, TokenStatusOverlay)</name>
  <files>src/components/domain/encounter/TokenLayer.tsx, src/components/domain/encounter/Token.tsx, src/components/domain/encounter/TokenStatusOverlay.tsx, src/components/domain/encounter/EncounterMapRenderer.css</files>
  <action>
1. Create `TokenStatusOverlay.tsx`:
   - Props: `status: TokenStatus[]`, `tokenRadius: number`
   - Renders SVG elements positioned around the token:
     - `wounded`: Small red circle (#8b5555) at top-right of token (cx=tokenRadius*0.7, cy=-tokenRadius*0.7, r=4) with CSS animation class `status-indicator--wounded`
     - `dead`: Red X lines across the full token (two diagonal lines spanning tokenRadius, stroke=#8b5555, strokeWidth=2) with class `status-indicator--dead`
     - `panicked`: Dashed circle ring around token (r=tokenRadius+3, stroke=#8b7355, strokeDasharray="4 4") with CSS animation class `status-indicator--panicked`
     - `stunned`: Small amber circle (#8b7355) at bottom-right (cx=tokenRadius*0.7, cy=tokenRadius*0.7, r=4)
     - `hidden`: Reduce parent opacity (handled via CSS class on parent Token group)
   - Wrap in `<g className="encounter-map__token-status">`

2. Create `Token.tsx`:
   - Props: `id: string`, `data: TokenData`, `unitSize: number`, `onSelect?: () => void`
   - Calculate position: `centerX = data.x * unitSize + unitSize / 2`, `centerY = data.y * unitSize + unitSize / 2`
   - Token radius: `unitSize * 0.35` (70% of cell, leaves room for status indicators)
   - Render as `<g>` with transform translate to centerX, centerY:
     - Main circle with class `encounter-map__token-body` and type-specific class `encounter-map__token--{data.type}`
     - Text label (data.name, first 3 chars uppercase) centered, class `encounter-map__token-label`, fontSize based on unitSize (unitSize * 0.22, min 8, max 14)
     - TokenStatusOverlay component with current status array and tokenRadius
   - Add `encounter-map__token--hidden` class when status includes 'hidden' (CSS: opacity 0.3)
   - onClick handler calls onSelect if provided

3. Create `TokenLayer.tsx`:
   - Props: `tokens: TokenState`, `unitSize: number`, `onTokenSelect?: (tokenId: string) => void`
   - Renders `<g className="encounter-map__token-layer">` containing Token components for each entry in tokens
   - Map over `Object.entries(tokens)` to render each Token with its id and data

4. Add CSS to `EncounterMapRenderer.css` for token styling:
   - `.encounter-map__token-layer` - no special styles, just grouping
   - `.encounter-map__token` - cursor: default, transition: opacity 0.2s
   - `.encounter-map__token-body` - fill: var(--color-teal, #4a6b6b), stroke: #2a3a3a, stroke-width: 2
   - `.encounter-map__token--player .encounter-map__token-body` - fill: #8b7355 (amber), stroke: #9a8065
   - `.encounter-map__token--npc .encounter-map__token-body` - fill: #4a6b6b (teal), stroke: #5a7a7a
   - `.encounter-map__token--creature .encounter-map__token-body` - fill: #6b4a4a (burgundy), stroke: #8b5555
   - `.encounter-map__token--object .encounter-map__token-body` - fill: #1a1a1a, stroke: #3a3a3a, stroke-dasharray: 3 3
   - `.encounter-map__token-label` - fill: #e0e0e0, font-family: 'Cascadia Code' monospace, text-anchor: middle, pointer-events: none, user-select: none
   - `.encounter-map__token--hidden` - opacity: 0.3
   - Status indicator animations:
     - `@keyframes pulse-wounded { 0%,100% { opacity: 1 } 50% { opacity: 0.5 } }` with `.status-indicator--wounded { animation: pulse-wounded 1.5s ease-in-out infinite }`
     - `@keyframes pulse-panicked { 0%,100% { opacity: 1; stroke-width: 2 } 50% { opacity: 0.4; stroke-width: 3 } }` with `.status-indicator--panicked { animation: pulse-panicked 1s ease-in-out infinite }`
     - `.status-indicator--dead` - no animation, static red X
  </action>
  <verify>
Run `npm run typecheck` to confirm no TypeScript errors. Verify all 3 component files exist and export their named components.
  </verify>
  <done>TokenLayer, Token, and TokenStatusOverlay components render SVG tokens with type-specific colors, name labels, and animated status indicators. CSS classes match the project's color palette.</done>
</task>

<task type="auto">
  <name>Task 2: Wire tokens through EncounterMapRenderer, EncounterView, and SharedConsole polling</name>
  <files>src/components/domain/encounter/EncounterMapRenderer.tsx, src/components/domain/encounter/EncounterMapDisplay.tsx, src/components/domain/encounter/EncounterView.tsx, src/entries/SharedConsole.tsx</files>
  <action>
1. Extend `EncounterMapRenderer` props interface:
   - Add `tokens?: TokenState` (import TokenState from `@/types/encounterMap`)
   - Add `onTokenSelect?: (tokenId: string) => void`
   - Import `TokenLayer` from `./TokenLayer`
   - Render `<TokenLayer>` inside the SVG, AFTER the POIs group (last SVG child, so tokens render on top of everything):
     ```
     {tokens && Object.keys(tokens).length > 0 && (
       <TokenLayer tokens={tokens} unitSize={unitSize} onTokenSelect={onTokenSelect} />
     )}
     ```
   - In the `handleMouseDown` function, add `target.closest('.encounter-map__token')` to the list of interactive elements that prevent panning (alongside room, terminal, poi, door checks).

2. Extend `EncounterMapDisplay` props:
   - Add `tokens?: TokenState` prop
   - Pass `tokens` through to both EncounterMapRenderer calls (multi-deck and single-deck paths)

3. Extend `EncounterView` props:
   - Add `tokens?: TokenState` prop (import TokenState)
   - Pass `tokens` to `<EncounterMapDisplay>` in the map viewMode render

4. Wire `SharedConsole.tsx`:
   - In the `ActiveViewData` interface (around line 55-70), add: `encounter_tokens?: TokenState` (import TokenState from `@/types/encounterMap`)
   - The existing polling already fetches `get_active_view_json` which now returns `encounter_tokens` (from Plan 01). The data flows through `activeView` state.
   - In the EncounterView render (around line 935-944), add the tokens prop:
     `tokens={activeView?.encounter_tokens}`

5. Verify the data flow chain is complete:
   - Django `get_active_view_json` -> `encounter_tokens` in JSON
   - SharedConsole polls -> stores in `activeView` state
   - SharedConsole renders `<EncounterView tokens={activeView.encounter_tokens} ...>`
   - EncounterView -> EncounterMapDisplay -> EncounterMapRenderer -> TokenLayer -> Token
  </action>
  <verify>
Run `npm run typecheck` to confirm no TypeScript errors. Run `npm run build` to verify the production build succeeds. Visually confirm the data flow by tracing imports: SharedConsole -> EncounterView -> EncounterMapDisplay -> EncounterMapRenderer -> TokenLayer.
  </verify>
  <done>Tokens flow from API polling through SharedConsole -> EncounterView -> EncounterMapDisplay -> EncounterMapRenderer -> TokenLayer -> Token. Players see tokens on the encounter map rendered above rooms, doors, and POIs. Token dragging on encounter map background does not interfere with pan/zoom.</done>
</task>

</tasks>

<verification>
- `npm run typecheck` passes
- `npm run build` succeeds
- Token components (TokenLayer, Token, TokenStatusOverlay) exist with correct exports
- EncounterMapRenderer renders TokenLayer above POIs
- SharedConsole passes encounter_tokens from polling to EncounterView
- Token CSS provides 4 distinct type colors and 3 status animations
</verification>

<success_criteria>
- Tokens render as colored SVG circles at correct grid positions on the encounter map
- Player tokens are amber, NPC tokens are teal, creature tokens are burgundy, object tokens are dashed gray
- Token name labels display (truncated to 3 chars)
- Wounded status shows pulsing red dot, dead shows red X, panicked shows dashed ring
- Tokens render above all other map elements (rooms, doors, POIs)
- Player terminal receives and displays tokens via 2-second polling
- Clicking tokens on map does not trigger map panning
</success_criteria>

<output>
After completion, create `.planning/phases/03-encounter-tokens/03-02-SUMMARY.md`
</output>
