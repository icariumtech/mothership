{% extends 'terminal/base.html' %}

{% block title %}GM Console - Send Messages{% endblock %}

{% block header %}GAME MASTER CONTROL CONSOLE{% endblock %}
{% block subtitle %}MESSAGE BROADCASTING SYSTEM{% endblock %}

{% block extra_css %}
    /* Angular panel with chamfered corners */
    .angular-panel {
        clip-path: polygon(
            12px 0, 100% 0, 100% calc(100% - 12px),
            calc(100% - 12px) 100%, 0 100%, 0 12px
        );
        position: relative;
    }

    .angular-panel-border {
        border: 2px solid var(--color-border-main);
        position: relative;
    }

    .angular-panel-border::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        clip-path: polygon(
            12px 0, 100% 0, 100% calc(100% - 12px),
            calc(100% - 12px) 100%, 0 100%, 0 12px
        );
        border: inherit;
        pointer-events: none;
    }

    .console-layout {
        display: flex !important;
        flex-direction: row !important;
        gap: 20px !important;
        margin-top: 20px;
        width: 100%;
    }

    /* Location Tree Sidebar - Outer wrapper with border */
    .location-browser-wrapper {
        position: relative;
        width: 380px;
        flex-shrink: 0;
        background-color: var(--color-bg-panel);
        max-height: calc(100vh - 250px);
        display: flex;
        flex-direction: column;
        clip-path: polygon(
            0 12px,
            12px 0,
            100% 0,
            100% calc(100% - 12px),
            calc(100% - 12px) 100%,
            0 100%
        );

        /* Draw borders using box-shadow to avoid clip-path cutting them */
        box-shadow:
            /* Top border */
            inset 0 2px 0 0 var(--color-border-main),
            /* Right border */
            inset -2px 0 0 0 var(--color-border-main),
            /* Bottom border */
            inset 0 -2px 0 0 var(--color-border-main),
            /* Left border */
            inset 2px 0 0 0 var(--color-border-main);
    }

    /* Draw the diagonal corner lines using linear gradients */
    .location-browser-wrapper::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 12px;
        height: 12px;
        background: linear-gradient(
            to bottom right,
            transparent calc(50% - 2px),
            var(--color-border-main) calc(50% - 2px),
            var(--color-border-main) calc(50% + 2px),
            transparent calc(50% + 2px)
        );
        pointer-events: none;
    }

    .location-browser-wrapper::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        background: linear-gradient(
            to bottom right,
            transparent calc(50% - 2px),
            var(--color-border-main) calc(50% - 2px),
            var(--color-border-main) calc(50% + 2px),
            transparent calc(50% + 2px)
        );
        pointer-events: none;
    }

    /* Fixed header */
    .location-browser-header {
        padding: 12px 12px 0 12px;
        flex-shrink: 0;
    }

    .location-browser-header h3 {
        color: var(--color-teal);
        font-size: 13px;
        letter-spacing: 2px;
        margin: 0 0 12px 0;
        border-bottom: 1px solid var(--color-border-subtle);
        padding-bottom: 5px;
    }

    /* Scrollable content area */
    .location-browser {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 0 12px 12px 12px;
    }

    /* Tree View Styles */
    .tree-view {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .tree-item {
        position: relative;
        margin: 0;
    }

    /* Tree visual connectors */
    .tree-item::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 1px;
        background: var(--color-border-subtle);
    }

    .tree-item:last-child::before {
        bottom: 50%;
    }

    .tree-root > .tree-item::before {
        display: none;
    }

    /* Location styling */
    .location-row {
        display: flex;
        align-items: center;
        padding: 0;
        margin: 4px 0;
        position: relative;
        border: 1px solid var(--color-border-subtle);
        background-color: var(--color-bg-primary);
        transition: all 0.2s;
    }

    .location-row.displaying {
        border-color: var(--color-active);
        background-color: var(--color-bg-panel-dark);
    }

    .location-content {
        flex: 1;
        display: flex;
        align-items: center;
        padding: 8px 6px;
        cursor: pointer;
    }

    .location-content:hover {
        background-color: var(--color-bg-panel-dark);
    }

    /* Tree connector graphics */
    .tree-connector {
        flex-shrink: 0;
        width: 24px;
        height: 20px;
        position: relative;
        margin-right: 4px;
    }

    .tree-connector::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        width: 1px;
        height: 100%;
        background: var(--color-border-subtle);
    }

    .tree-connector::after {
        content: '';
        position: absolute;
        left: 10px;
        top: 50%;
        width: 10px;
        height: 1px;
        background: var(--color-border-subtle);
    }

    .tree-root > .tree-item > .location-row > .tree-connector::before,
    .tree-root > .tree-item > .location-row > .tree-connector::after {
        display: none;
    }

    /* Toggle triangle indicator */
    .tree-toggle {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
        color: var(--color-teal);
        font-size: 12px;
        line-height: 20px;
        text-align: center;
        margin-right: 6px;
        transition: transform 0.2s;
        user-select: none;
    }

    .tree-toggle.empty {
        visibility: hidden;
    }

    /* Location name */
    .location-name {
        color: var(--color-teal-bright);
        font-size: 13px;
        font-weight: bold;
        letter-spacing: 0.5px;
        flex-grow: 1;
        user-select: none;
    }

    /* Display button for locations */
    .display-btn-container {
        flex-shrink: 0;
        background-color: var(--color-bg-panel-dark);
        border-left: 1px solid var(--color-border-subtle);
        padding: 6px 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 48px;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
    }

    .display-btn-container:hover {
        background-color: var(--color-bg-panel);
    }

    .display-btn-container.active {
        background-color: var(--color-active);
    }

    .display-btn-icon {
        color: var(--color-teal);
        font-size: 20px;
    }

    .display-btn-container.active .display-btn-icon {
        color: var(--color-bg-primary);
    }

    /* Child locations */
    .location-children {
        list-style: none;
        padding-left: 24px;
        margin: 0;
        display: none;
    }

    .location-children.expanded {
        display: block;
    }

    /* Terminal list */
    .terminal-list {
        list-style: none;
        padding-left: 24px;
        margin: 0;
        display: none;
    }

    .terminal-list.expanded {
        display: block;
    }

    .terminal-row {
        display: flex;
        align-items: center;
        padding: 0;
        margin: 4px 0;
        position: relative;
        border: 1px solid var(--color-border-subtle);
        background-color: var(--color-bg-primary);
        transition: all 0.2s;
    }

    .terminal-content {
        flex: 1;
        display: flex;
        align-items: center;
        padding: 6px 6px;
    }

    .terminal-name {
        color: var(--color-teal-bright);
        font-size: 12px;
        flex-grow: 1;
        user-select: none;
    }

    .terminal-owner {
        color: var(--color-text-secondary);
        font-size: 10px;
        margin-left: 8px;
        margin-right: 6px;
        user-select: none;
    }

    /* Show button for terminals */
    .show-btn-container {
        flex-shrink: 0;
        background-color: var(--color-bg-panel-dark);
        border-left: 1px solid var(--color-border-subtle);
        padding: 6px 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 48px;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
    }

    .show-btn-container:hover {
        background-color: var(--color-bg-panel);
    }

    .show-btn-icon {
        color: var(--color-teal);
        font-size: 16px;
    }

    /* Momentary flash effect for terminal show */
    @keyframes flash-show {
        0% {
            background-color: var(--color-active);
        }
        100% {
            background-color: var(--color-bg-panel-dark);
        }
    }

    .show-btn-container.flashing {
        animation: flash-show 0.5s ease-out;
    }

    .show-btn-container.flashing .show-btn-icon {
        animation: flash-icon 0.5s ease-out;
    }

    @keyframes flash-icon {
        0% {
            color: var(--color-bg-primary);
        }
        100% {
            color: var(--color-teal);
        }
    }

    /* Main Console Area */
    .console-main {
        display: flex;
        flex-direction: column;
        gap: 15px;
        flex: 1;
        min-width: 0;
    }

    .active-view-info {
        position: relative;
        padding: 12px 15px;
        background-color: var(--color-bg-panel);
        clip-path: polygon(
            0 12px,
            12px 0,
            100% 0,
            100% calc(100% - 12px),
            calc(100% - 12px) 100%,
            0 100%
        );
        box-shadow:
            inset 0 2px 0 0 var(--color-border-main),
            inset -2px 0 0 0 var(--color-border-main),
            inset 0 -2px 0 0 var(--color-border-main),
            inset 2px 0 0 0 var(--color-border-main);
    }

    .active-view-info::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 12px;
        height: 12px;
        background: linear-gradient(
            to bottom right,
            transparent calc(50% - 2px),
            var(--color-border-main) calc(50% - 2px),
            var(--color-border-main) calc(50% + 2px),
            transparent calc(50% + 2px)
        );
        pointer-events: none;
    }

    .active-view-info::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        background: linear-gradient(
            to bottom right,
            transparent calc(50% - 2px),
            var(--color-border-main) calc(50% - 2px),
            var(--color-border-main) calc(50% + 2px),
            transparent calc(50% + 2px)
        );
        pointer-events: none;
    }

    .active-view-info h3 {
        color: var(--color-amber);
        font-size: 11px;
        letter-spacing: 2px;
        margin: 0 0 8px 0;
    }

    .active-view-info p {
        color: var(--color-text-secondary);
        font-size: 10px;
        margin: 3px 0;
    }

    .console-form {
        position: relative;
        padding: 15px;
        background-color: var(--color-bg-panel);
        clip-path: polygon(
            0 12px,
            12px 0,
            100% 0,
            100% calc(100% - 12px),
            calc(100% - 12px) 100%,
            0 100%
        );
        box-shadow:
            inset 0 2px 0 0 var(--color-border-main),
            inset -2px 0 0 0 var(--color-border-main),
            inset 0 -2px 0 0 var(--color-border-main),
            inset 2px 0 0 0 var(--color-border-main);
    }

    .console-form::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 12px;
        height: 12px;
        background: linear-gradient(
            to bottom right,
            transparent calc(50% - 2px),
            var(--color-border-main) calc(50% - 2px),
            var(--color-border-main) calc(50% + 2px),
            transparent calc(50% + 2px)
        );
        pointer-events: none;
    }

    .console-form::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 0;
        width: 12px;
        height: 12px;
        background: linear-gradient(
            to bottom right,
            transparent calc(50% - 2px),
            var(--color-border-main) calc(50% - 2px),
            var(--color-border-main) calc(50% + 2px),
            transparent calc(50% + 2px)
        );
        pointer-events: none;
    }

    .console-form h2 {
        margin: 0 0 15px 0;
        font-size: 14px;
        letter-spacing: 2px;
        color: var(--color-teal);
    }

    .form-group {
        margin-bottom: 15px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        color: var(--color-teal);
        font-size: 12px;
        letter-spacing: 1px;
    }

    input[type="text"],
    textarea,
    select {
        width: 100%;
        background-color: var(--color-bg-primary);
        color: var(--color-text-primary);
        border: 1px solid var(--color-border-main);
        padding: 10px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
    }

    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--color-teal-bright);
        box-shadow: 0 0 5px rgba(74, 107, 107, 0.3);
    }

    textarea {
        min-height: 100px;
        resize: vertical;
    }

    button {
        background-color: var(--color-active);
        color: var(--color-bg-primary);
        border: 2px solid var(--color-active);
        padding: 12px 30px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        font-weight: bold;
        letter-spacing: 2px;
        cursor: pointer;
        transition: all 0.2s;
    }

    button:hover {
        background-color: var(--color-amber-bright);
        border-color: var(--color-amber-bright);
        box-shadow: 0 0 10px rgba(139, 115, 85, 0.3);
    }

    .recent-messages {
        margin-top: 0;
    }

    .recent-messages h2 {
        border-bottom: 1px solid var(--color-border-main);
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 18px;
        letter-spacing: 2px;
        color: var(--color-teal);
    }

    .message-preview {
        border: 1px solid var(--color-border-subtle);
        padding: 10px;
        margin-bottom: 10px;
        background-color: var(--color-bg-secondary);
        font-size: 12px;
    }

    .message-preview-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        color: var(--color-text-secondary);
    }

    .message-preview-content {
        color: var(--color-text-primary);
    }
{% endblock %}

{% block content %}
<div class="console-layout" style="display: flex !important; flex-direction: row !important; gap: 20px; width: 100%;">
    <!-- Location Tree Sidebar -->
    <div class="location-browser-wrapper">
        <div class="location-browser-header">
            <h3>LOCATIONS</h3>
        </div>
        <div class="location-browser">
            <ul class="tree-view tree-root">
                {% for location in locations %}
                    {% include 'terminal/tree_location.html' with location=location depth=0 %}
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Main Console Area -->
    <div class="console-main" style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
        <!-- Active View Info -->
        <div class="active-view-info">
            <h3>ACTIVE DISPLAY VIEW</h3>
            {% if active_view.location_slug %}
                {% for location in locations %}
                    {% if location.slug == active_view.location_slug %}
                        <p>&gt; LOCATION: {{ location.name|upper }}</p>
                    {% endif %}
                {% endfor %}
                {% if active_view.view_type == 'COMM_TERMINAL' and active_view.view_slug %}
                    <p>&gt; TERMINAL: {{ active_view.view_slug|upper }}</p>
                {% elif active_view.view_type == 'ENCOUNTER_MAP' and active_view.view_slug %}
                    <p>&gt; MAP: {{ active_view.view_slug|upper }}</p>
                {% else %}
                    <p>&gt; VIEW: LOCATION OVERVIEW</p>
                {% endif %}
            {% else %}
                <p>&gt; No location selected</p>
            {% endif %}
            <p>&gt; UPDATED: {{ active_view.updated_at|date:"Y-m-d H:i:s" }}</p>
        </div>

        <!-- Broadcast Message Form -->
        <div class="console-form">
            <h2>BROADCAST MESSAGE</h2>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="send_message" value="1">

                <div class="form-group">
                    <label for="sender">SENDER:</label>
                    <input type="text" id="sender" name="sender" value="CHARON" placeholder="System name...">
                </div>

                <div class="form-group">
                    <label for="priority">PRIORITY:</label>
                    <select id="priority" name="priority">
                        <option value="LOW">LOW</option>
                        <option value="NORMAL" selected>NORMAL</option>
                        <option value="HIGH">HIGH</option>
                        <option value="CRITICAL">CRITICAL</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="content">MESSAGE:</label>
                    <textarea id="content" name="content" placeholder="Enter broadcast message..." required></textarea>
                </div>

                <button type="submit">TRANSMIT</button>
            </form>
        </div>
    </div>
</div>

<script>
// Tree state persistence
const TREE_STATE_KEY = 'gm_console_tree_state';

// Get expanded state from localStorage
function getExpandedState() {
    const stored = localStorage.getItem(TREE_STATE_KEY);
    return stored ? JSON.parse(stored) : {};
}

// Save expanded state to localStorage
function saveExpandedState(expandedSlugs) {
    localStorage.setItem(TREE_STATE_KEY, JSON.stringify(expandedSlugs));
}

// Toggle tree item (location children + terminals)
function toggleTreeItem(locationSlug) {
    const childrenList = document.getElementById('children-' + locationSlug);
    const terminalList = document.getElementById('terminals-' + locationSlug);
    const toggle = document.getElementById('toggle-' + locationSlug);

    let isExpanded = false;

    // Check if currently expanded
    if (childrenList && childrenList.classList.contains('expanded')) {
        isExpanded = true;
    }
    if (terminalList && terminalList.classList.contains('expanded')) {
        isExpanded = true;
    }

    // Get current state
    const expandedState = getExpandedState();

    // Toggle expansion
    if (isExpanded) {
        if (childrenList) childrenList.classList.remove('expanded');
        if (terminalList) terminalList.classList.remove('expanded');
        toggle.innerHTML = '&#9654;'; // Right-pointing triangle
        delete expandedState[locationSlug];
    } else {
        if (childrenList) childrenList.classList.add('expanded');
        if (terminalList) terminalList.classList.add('expanded');
        toggle.innerHTML = '&#9660;'; // Down-pointing triangle
        expandedState[locationSlug] = true;
    }

    // Save state
    saveExpandedState(expandedState);
}

// Display a location (shows map or location overview) - clears previous selection
function displayLocation(locationSlug) {
    // Save current tree state before navigating
    saveCurrentTreeState();
    // When displaying a location, show the map if available, otherwise location overview
    submitViewSwitch(locationSlug, 'ENCOUNTER_MAP', '');
}

// Show a terminal (displays terminal overlay without changing main view)
function showTerminal(locationSlug, terminalSlug, buttonElement) {
    // Add flashing effect to button
    buttonElement.classList.add('flashing');

    // Remove flashing class after animation completes
    setTimeout(() => {
        buttonElement.classList.remove('flashing');
    }, 500);

    // Submit the overlay terminal (doesn't change the main display)
    submitTerminalOverlay(locationSlug, terminalSlug);
}

// Submit terminal overlay form (separate from view switching)
function submitTerminalOverlay(locationSlug, terminalSlug) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '';

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const fields = {
        'csrfmiddlewaretoken': csrfToken,
        'show_terminal': '1',
        'location_slug': locationSlug,
        'terminal_slug': terminalSlug
    };

    for (const [name, value] of Object.entries(fields)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        form.appendChild(input);
    }

    document.body.appendChild(form);
    form.submit();
}

// Save current tree state
function saveCurrentTreeState() {
    const expandedState = {};
    document.querySelectorAll('.location-children.expanded, .terminal-list.expanded').forEach(el => {
        const match = el.id.match(/(?:children|terminals)-(.+)/);
        if (match) {
            expandedState[match[1]] = true;
        }
    });
    saveExpandedState(expandedState);
}

// Submit the view switch form
function submitViewSwitch(locationSlug, viewType, viewSlug) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '';

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const fields = {
        'csrfmiddlewaretoken': csrfToken,
        'switch_view': '1',
        'location_slug': locationSlug,
        'view_type': viewType,
        'view_slug': viewSlug
    };

    for (const [name, value] of Object.entries(fields)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        form.appendChild(input);
    }

    document.body.appendChild(form);
    form.submit();
}

// Restore tree state and auto-expand path to active item on page load
document.addEventListener('DOMContentLoaded', function() {
    // First, restore previously expanded items from localStorage
    const expandedState = getExpandedState();
    for (const slug in expandedState) {
        const childrenList = document.getElementById('children-' + slug);
        const terminalList = document.getElementById('terminals-' + slug);
        const toggle = document.getElementById('toggle-' + slug);

        if (childrenList) childrenList.classList.add('expanded');
        if (terminalList) terminalList.classList.add('expanded');
        if (toggle) toggle.innerHTML = '&#9660;'; // Down-pointing triangle
    }

    // Then, ensure path to active item is expanded (and saved to state)
    const activeItem = document.querySelector('.location-row.displaying');

    if (activeItem) {
        // Traverse up the tree and expand all parent items
        let current = activeItem.closest('.tree-item');

        while (current) {
            // Find the toggle button for this tree item
            const locationRow = current.querySelector(':scope > .location-row');
            if (locationRow) {
                const onclick = locationRow.getAttribute('onclick');
                if (onclick) {
                    const match = onclick.match(/toggleTreeItem\('([^']+)'\)/);
                    if (match) {
                        const slug = match[1];
                        const childrenList = document.getElementById('children-' + slug);
                        const terminalList = document.getElementById('terminals-' + slug);
                        const toggle = document.getElementById('toggle-' + slug);

                        if (childrenList) childrenList.classList.add('expanded');
                        if (terminalList) terminalList.classList.add('expanded');
                        if (toggle) toggle.innerHTML = '&#9660;'; // Down-pointing triangle

                        // Add to expanded state
                        expandedState[slug] = true;
                    }
                }
            }

            // Move up to parent tree item
            current = current.parentElement.closest('.tree-item');
        }

        // Save updated state
        saveExpandedState(expandedState);
    }
});
</script>
{% endblock %}
