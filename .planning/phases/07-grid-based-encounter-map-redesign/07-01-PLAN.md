---
phase: 07-grid-based-encounter-map-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/encounterMap.ts
  - data/galaxy/sol/earth/uscss_morrigan/map/deck_1.yaml
  - data/galaxy/sol/earth/uscss_morrigan/map/deck_2.yaml
  - data/galaxy/kepler-442/kepler-442b/base_alpha/map/main_facility.yaml
autonomous: true
requirements: [GRID-01, GRID-02]

must_haves:
  truths:
    - "New TypeScript types (GridRect, GridRoom, DoorDef, GridEncounterMapData) are exported from encounterMap.ts"
    - "isGridEncounterMap() type guard correctly identifies grid-based maps by presence of rooms[0].rects"
    - "Old types (RoomData, EncounterMapData, isEncounterMap) remain exported for backward compatibility"
    - "deck_1.yaml and deck_2.yaml use the new rooms+rects format with no grid.width/grid.height"
    - "main_facility.yaml is a valid single-deck grid map demonstrating L-shape and corridor rooms"
    - "npm run typecheck passes with 0 errors after type additions"
  artifacts:
    - path: "src/types/encounterMap.ts"
      provides: "GridRect, WallSide, DoorDef, GridRoom, GridEncounterMapData types + isGridEncounterMap guard"
      contains: "isGridEncounterMap"
    - path: "data/galaxy/sol/earth/uscss_morrigan/map/deck_1.yaml"
      provides: "Main deck in grid format (rooms with rects, doors on walls)"
    - path: "data/galaxy/sol/earth/uscss_morrigan/map/deck_2.yaml"
      provides: "Lower deck in grid format"
    - path: "data/galaxy/kepler-442/kepler-442b/base_alpha/map/main_facility.yaml"
      provides: "Sample facility map demonstrating irregular shapes"
  key_links:
    - from: "src/types/encounterMap.ts"
      to: "isGridEncounterMap() guard"
      via: "Array.isArray(mapData.rooms[0].rects)"
      pattern: "isGridEncounterMap"
    - from: "deck_1.yaml rooms"
      to: "GridRoom schema"
      via: "rects: [{x, y, w, h}] and doors: [{wall, position, type, status}]"
      pattern: "rects:"
---

<objective>
Add grid-based encounter map TypeScript types and rebuild YAML map data files in the new format.

Purpose: Establish the shared data contract (types + schemas) that all renderer and panel code will consume. This plan creates the foundation that Wave 2 plans depend on.
Output: New types in encounterMap.ts (backward-compatible additions), three rebuilt YAML map files in grid format.
</objective>

<execution_context>
@/home/gjohnson/.claude/get-shit-done/workflows/execute-plan.md
@/home/gjohnson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-grid-based-encounter-map-redesign/07-RESEARCH.md
@src/types/encounterMap.ts
@data/galaxy/sol/earth/uscss_morrigan/map/deck_1.yaml
@data/galaxy/sol/earth/uscss_morrigan/map/deck_2.yaml
@data/galaxy/sol/earth/uscss_morrigan/map/manifest.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add grid-based TypeScript types to encounterMap.ts</name>
  <files>src/types/encounterMap.ts</files>
  <action>
Append new grid-based types to the BOTTOM of src/types/encounterMap.ts. Do NOT remove or change any existing types — old types (RoomData, EncounterMapData, isEncounterMap, etc.) must remain exported for backward compatibility during the migration.

Add the following new exports after the existing code:

```typescript
// ============================================================
// Grid-based encounter map types (Phase 7)
// ============================================================

/** A single axis-aligned rectangle in grid cell units */
export interface GridRect {
  x: number;  // grid cell X (left edge, 0-based)
  y: number;  // grid cell Y (top edge, 0-based)
  w: number;  // width in cells
  h: number;  // height in cells
}

/** Cardinal wall sides for door attachment */
export type WallSide = 'north' | 'south' | 'east' | 'west';

/** A door attached to a specific wall of a room */
export interface DoorDef {
  wall: WallSide;
  position: number;     // 0-based cell index along the wall (counts only cells with an actual wall segment)
  type: DoorType;       // standard | airlock | blast_door | emergency
  status: DoorStatus;   // OPEN | CLOSED | LOCKED | SEALED
}

/** A room composed of one or more grid rectangles */
export interface GridRoom {
  id: string;
  name: string;         // empty string = corridor/hallway (no label rendered)
  rects: GridRect[];    // list of axis-aligned rectangles that make up this room
  doors?: DoorDef[];
  description?: string;
  type?: string;        // optional tag: corridor | bridge | cargo | medical | etc.
}

/** Complete grid-based encounter map (new format) */
export interface GridEncounterMapData {
  name: string;
  deck_id?: string;
  location_name?: string;
  description?: string;
  unit_size?: number;   // pixels per cell — default 40 if omitted
  rooms: GridRoom[];
  terminals?: TerminalData[];
  poi?: PoiData[];
  metadata?: MapMetadata;
}

/**
 * Type guard: identifies grid-based maps by presence of rects on first room.
 * Used by EncounterMapDisplay to route to the new renderer.
 */
export function isGridEncounterMap(mapData: unknown): mapData is GridEncounterMapData {
  if (!mapData || typeof mapData !== 'object') return false;
  const m = mapData as Record<string, unknown>;
  return (
    Array.isArray(m.rooms) &&
    m.rooms.length > 0 &&
    Array.isArray((m.rooms[0] as Record<string, unknown>).rects)
  );
}
```

Note: `DoorType`, `DoorStatus`, `TerminalData`, `PoiData`, `MapMetadata` are already defined above in the file — no need to re-declare them.
  </action>
  <verify>cd /home/gjohnson/mothership/charon && npm run typecheck 2>&1 | tail -5</verify>
  <done>npm run typecheck exits with 0 errors. isGridEncounterMap, GridRoom, GridRect, DoorDef, GridEncounterMapData are all exported from src/types/encounterMap.ts.</done>
</task>

<task type="auto">
  <name>Task 2: Rebuild YAML map files in grid-based format</name>
  <files>
    data/galaxy/sol/earth/uscss_morrigan/map/deck_1.yaml
    data/galaxy/sol/earth/uscss_morrigan/map/deck_2.yaml
    data/galaxy/kepler-442/kepler-442b/base_alpha/map/main_facility.yaml
  </files>
  <action>
Replace all three map YAML files with the new grid-based format. The manifest.yaml is unchanged — it still references deck_1.yaml and deck_2.yaml by filename.

**Key schema rules (per CONTEXT.md locked decisions):**
- Top-level `unit_size: 40` — no `grid:` block, no `grid.width`, no `grid.height`
- `rooms:` array with `id`, `name`, `rects: [{x, y, w, h}]`, optional `doors`, `description`, `type`
- `doors:` on a room: `{wall: north|south|east|west, position: N, type: standard|airlock|blast_door|emergency, status: OPEN|CLOSED|LOCKED|SEALED}`
- No `connections:` array — doors are on rooms, not between rooms
- No `status:` on rooms — the old RoomStatus field is gone
- `position` on a door counts exterior wall cells along that side from the left/top (0-based)
- Corridors are rooms with `name: ""` (empty string)

**deck_1.yaml — USCSS Morrigan Main Deck:**

Lay out rooms on a compact grid. Rooms must touch (share walls) rather than float. Design:
- Bridge: 5w x 3h at (0, 0)
- Corridor to crew: 3w x 1h at (5, 1) — unnamed corridor
- Crew Quarters: 5w x 3h at (8, 0)
- Corridor to medical: 3w x 1h at (13, 1) — unnamed corridor
- Medical Bay: 5w x 3h at (16, 0)
- Corridor (vertical, bridge to engineering): 1w x 2h at (2, 3)
- Engineering: 5w x 4h at (0, 5)
- Corridor (engineering to cargo): 1w x 1h at (5, 6) — unnamed
- Cargo Bay: 6w x 4h at (6, 5)
- Corridor (cargo to airlock): 1w x 1h at (12, 6) — unnamed
- Airlock Bay: 5w x 4h at (13, 5)
- Life Support: 5w x 3h at (0, 10) — connected south of engineering by corridor 1w x 1h at (2, 9)

For doors: attach doors to the rooms they logically connect. A door between Bridge and Crew Quarters goes on Bridge's east wall (position 1) and also on Crew Quarters' west wall (position 1). Both door entries describe the same physical doorway from their respective room's perspective.

Example door entries for deck_1.yaml (use these for the main connections):
- Bridge east wall → standard OPEN (position 1, connects to corridor)
- Crew Quarters west wall → standard OPEN (position 1)
- Crew Quarters east wall → standard CLOSED (position 1, to medical corridor)
- Medical Bay west wall → standard CLOSED (position 1)
- Bridge south wall → blast_door CLOSED (position 2, to vertical corridor)
- Engineering north wall → blast_door CLOSED (position 2)
- Engineering east wall → standard OPEN (position 1, to cargo corridor)
- Cargo Bay west wall → standard OPEN (position 1)
- Cargo Bay east wall → airlock SEALED (position 1, to airlock corridor)
- Airlock Bay west wall → airlock SEALED (position 1)
- Engineering south wall → emergency LOCKED (position 2, to life support corridor)
- Life Support north wall → emergency LOCKED (position 2)

Keep terminals from original file using absolute grid coordinates (x, y as float within the new grid layout). Keep POIs similarly. Drop inter_deck_connections (not in new schema). Keep metadata.

**deck_2.yaml — USCSS Morrigan Lower Deck:**

Read the current deck_2.yaml first. Apply the same grid-based conversion. Lay out rooms touching each other. Keep room names and descriptions. Add doors between adjacent rooms. Use `unit_size: 40`.

**main_facility.yaml — Base Alpha facility (demonstration map):**

Replace the minimal stub with a single-deck grid map demonstrating irregular shapes. Use:

```yaml
name: "Base Alpha - Main Level"
deck_id: "main"
location_name: "Base Alpha"
description: "Primary mining operations floor"
unit_size: 40

rooms:
  - id: command_center
    name: "COMMAND CENTER"
    rects:
      - {x: 0, y: 0, w: 6, h: 4}
    doors:
      - {wall: east, position: 1, type: blast_door, status: CLOSED}
      - {wall: south, position: 2, type: standard, status: OPEN}
    description: "Primary operations and communications hub"
    type: bridge

  - id: main_corridor
    name: ""
    rects:
      - {x: 6, y: 1, w: 8, h: 2}   # east-west corridor
      - {x: 9, y: 3, w: 2, h: 4}   # north-south branch (T-shape)
    doors: []
    type: corridor

  - id: mining_control
    name: "MINING CONTROL"
    rects:
      - {x: 14, y: 0, w: 5, h: 4}
    doors:
      - {wall: west, position: 1, type: blast_door, status: CLOSED}
    description: "Drill operation monitoring and control"
    type: bridge

  - id: equipment_bay
    name: "EQUIPMENT BAY"
    rects:
      - {x: 7, y: 7, w: 6, h: 3}   # main floor
      - {x: 7, y: 10, w: 3, h: 2}  # alcove (L-shape)
    doors:
      - {wall: north, position: 2, type: standard, status: OPEN}
    description: "Heavy equipment storage and maintenance"
    type: cargo

  - id: med_station
    name: "MED STATION"
    rects:
      - {x: 14, y: 5, w: 4, h: 3}
    doors:
      - {wall: west, position: 1, type: standard, status: CLOSED}
    description: "Emergency medical treatment"
    type: medical

metadata:
  author: "GM"
  created: "2183-08-01"
  version: 1
  tags: ["facility", "mining", "base"]
```

After writing all three files, verify YAML is valid by checking the Python can parse it:
```bash
python3 -c "import yaml; yaml.safe_load(open('data/galaxy/sol/earth/uscss_morrigan/map/deck_1.yaml'))" && echo "deck_1 OK"
python3 -c "import yaml; yaml.safe_load(open('data/galaxy/sol/earth/uscss_morrigan/map/deck_2.yaml'))" && echo "deck_2 OK"
python3 -c "import yaml; yaml.safe_load(open('data/galaxy/kepler-442/kepler-442b/base_alpha/map/main_facility.yaml'))" && echo "main_facility OK"
```
  </action>
  <verify>
cd /home/gjohnson/mothership/charon && python3 -c "
import yaml
for f in ['data/galaxy/sol/earth/uscss_morrigan/map/deck_1.yaml', 'data/galaxy/sol/earth/uscss_morrigan/map/deck_2.yaml', 'data/galaxy/kepler-442/kepler-442b/base_alpha/map/main_facility.yaml']:
    d = yaml.safe_load(open(f))
    assert 'rooms' in d, f'{f}: missing rooms'
    assert 'rects' in d['rooms'][0], f'{f}: rooms[0] missing rects'
    assert 'grid' not in d, f'{f}: old grid key still present'
    print(f'OK: {f}')
"
  </verify>
  <done>All three YAML files parse without error, each has a rooms array where rooms[0] has a rects array, and none have a top-level grid: key.</done>
</task>

</tasks>

<verification>
Run after all tasks complete:
1. `cd /home/gjohnson/mothership/charon && npm run typecheck` — must pass with 0 errors
2. Check that `isGridEncounterMap`, `GridRoom`, `GridRect`, `DoorDef`, `GridEncounterMapData` are all present in `src/types/encounterMap.ts`
3. Verify all three YAML files parse with Python yaml.safe_load and have the new schema shape
4. Confirm `isEncounterMap` and `EncounterMapData` still exported (backward compat)
</verification>

<success_criteria>
- GridEncounterMapData and all grid types exported from encounterMap.ts
- isGridEncounterMap() correctly distinguishes grid vs old maps
- Old types unchanged (no TypeScript breakage in existing code)
- deck_1.yaml, deck_2.yaml, main_facility.yaml all use rects-based room format
- npm run typecheck passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-grid-based-encounter-map-redesign/07-01-SUMMARY.md`
</output>
