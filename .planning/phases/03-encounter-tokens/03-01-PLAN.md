---
phase: 03-encounter-tokens
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - terminal/models.py
  - terminal/views.py
  - terminal/urls.py
  - src/types/encounterMap.ts
  - src/types/gmConsole.ts
  - src/services/encounterApi.ts
autonomous: true

must_haves:
  truths:
    - "Token state persists in ActiveView and survives page refresh"
    - "API accepts place, move, remove, and set-status operations"
    - "Active view polling response includes encounter_tokens field"
    - "TypeScript types enforce token data shape across frontend"
  artifacts:
    - path: "terminal/models.py"
      provides: "encounter_tokens JSONField on ActiveView"
      contains: "encounter_tokens"
    - path: "terminal/views.py"
      provides: "Token CRUD API endpoints"
      exports: ["api_encounter_place_token", "api_encounter_move_token", "api_encounter_remove_token", "api_encounter_set_token_status"]
    - path: "terminal/urls.py"
      provides: "URL routes for token endpoints"
      contains: "encounter/place-token"
    - path: "src/types/encounterMap.ts"
      provides: "TokenData, TokenType, TokenStatus, TokenState interfaces"
      contains: "TokenData"
    - path: "src/services/encounterApi.ts"
      provides: "Frontend API client functions for token operations"
      contains: "placeToken"
  key_links:
    - from: "terminal/views.py"
      to: "terminal/models.py"
      via: "ActiveView.encounter_tokens JSONField read/write"
      pattern: "active_view\\.encounter_tokens"
    - from: "terminal/views.py (get_active_view_json)"
      to: "src/entries/SharedConsole.tsx"
      via: "encounter_tokens in polling response"
      pattern: "encounter_tokens"
    - from: "src/services/encounterApi.ts"
      to: "terminal/views.py"
      via: "POST requests to token endpoints"
      pattern: "encounter/(place|move|remove)-token"
---

<objective>
Backend data pipeline and TypeScript types for encounter tokens.

Purpose: Establish the data model, API endpoints, and type definitions that Plan 02 (rendering) and Plan 03 (GM controls) both depend on.
Output: ActiveView.encounter_tokens JSONField, 4 API endpoints, TypeScript types, and frontend API client functions.
</objective>

<execution_context>
@/home/gjohnson/.claude/get-shit-done/workflows/execute-plan.md
@/home/gjohnson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-encounter-tokens/03-RESEARCH.md
@terminal/models.py
@terminal/views.py
@terminal/urls.py
@src/types/encounterMap.ts
@src/types/gmConsole.ts
@src/services/encounterApi.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ActiveView model + API endpoints for token operations</name>
  <files>terminal/models.py, terminal/views.py, terminal/urls.py</files>
  <action>
1. Add `encounter_tokens` JSONField to ActiveView model (default=dict, blank=True), with help_text describing structure: `{ token_id: { type, x, y, name, status[] } }`. Run `python manage.py makemigrations terminal && python manage.py migrate`.

2. Update `get_active_view_json` in views.py to include `encounter_tokens` in the response: `'encounter_tokens': active_view.encounter_tokens or {}`.

3. Create 4 new API view functions in views.py (all @login_required, POST-only, following existing encounter API patterns like `api_encounter_toggle_room`):

   a. `api_encounter_place_token(request)`: Reads JSON body with `type` (player|npc|creature|object), `x` (int), `y` (int), `name` (str). Generates `token_id` using `f"{type}_{int(time.time()*1000)}"`. Validates type is one of the 4 allowed values. Stores in `active_view.encounter_tokens[token_id]` with `status: []`. Returns `{ success: true, token_id, tokens: active_view.encounter_tokens }`.

   b. `api_encounter_move_token(request)`: Reads `token_id`, `x`, `y`. Validates token exists. Updates x/y. Returns `{ success: true, token_id, tokens }`.

   c. `api_encounter_remove_token(request)`: Reads `token_id`. Removes from dict. Returns `{ success: true, token_id, tokens }`.

   d. `api_encounter_set_token_status(request)`: Reads `token_id`, `status` (list of strings from: wounded, dead, panicked, stunned, hidden). Validates token exists. Sets token's status list. Returns `{ success: true, token_id, tokens }`.

4. Add URL patterns in urls.py under the encounter section:
   - `api/gm/encounter/place-token/` -> `api_encounter_place_token`
   - `api/gm/encounter/move-token/` -> `api_encounter_move_token`
   - `api/gm/encounter/remove-token/` -> `api_encounter_remove_token`
   - `api/gm/encounter/set-token-status/` -> `api_encounter_set_token_status`

Use `import time` for token ID generation. Parse request body with `json.loads(request.body)` matching existing pattern in views.py.
  </action>
  <verify>
Run `python manage.py makemigrations --check` to verify no pending migrations. Run `python manage.py runserver --noreload` briefly to confirm no import errors. Verify the 4 new URL patterns appear: `grep -c 'encounter.*token' terminal/urls.py` should return 4.
  </verify>
  <done>ActiveView has encounter_tokens field, 4 token API endpoints exist and are routed, active view JSON response includes encounter_tokens.</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript types and frontend API client</name>
  <files>src/types/encounterMap.ts, src/types/gmConsole.ts, src/services/encounterApi.ts</files>
  <action>
1. Add token types to `src/types/encounterMap.ts` (at the end, before the type guards):

```typescript
// Token types for encounter map
export type TokenType = 'player' | 'npc' | 'creature' | 'object';
export type TokenStatus = 'wounded' | 'dead' | 'panicked' | 'stunned' | 'hidden';

export interface TokenData {
  type: TokenType;
  x: number;
  y: number;
  name: string;
  status: TokenStatus[];
}

export interface TokenState {
  [tokenId: string]: TokenData;
}
```

2. Add `encounter_tokens` to ActiveView interface in `src/types/gmConsole.ts`:
   - Add field: `encounter_tokens: TokenState;` (import TokenState from encounterMap)

3. Add token API functions to `src/services/encounterApi.ts`:

```typescript
// Token management
async function placeToken(type: TokenType, name: string, x: number, y: number): Promise<TokenResponse> {
  const response = await api.post<TokenResponse>('/gm/encounter/place-token/', { type, name, x, y });
  return response.data;
}

async function moveToken(tokenId: string, x: number, y: number): Promise<TokenResponse> {
  const response = await api.post<TokenResponse>('/gm/encounter/move-token/', { token_id: tokenId, x, y });
  return response.data;
}

async function removeToken(tokenId: string): Promise<TokenResponse> {
  const response = await api.post<TokenResponse>('/gm/encounter/remove-token/', { token_id: tokenId });
  return response.data;
}

async function setTokenStatus(tokenId: string, status: TokenStatus[]): Promise<TokenResponse> {
  const response = await api.post<TokenResponse>('/gm/encounter/set-token-status/', { token_id: tokenId, status });
  return response.data;
}
```

   Add `TokenResponse` interface: `{ success: boolean; token_id: string; tokens: TokenState; }`

   Import `TokenType`, `TokenStatus`, `TokenState` from `@/types/encounterMap`.

   Add all 4 functions to the exported `encounterApi` object.

4. Update the `DeckWithRooms` export to also export `TokenResponse`.
  </action>
  <verify>
Run `npm run typecheck` to confirm no TypeScript errors. Verify new types exist: `grep 'TokenData' src/types/encounterMap.ts` and `grep 'placeToken' src/services/encounterApi.ts`.
  </verify>
  <done>TokenData/TokenType/TokenStatus/TokenState types defined, ActiveView includes encounter_tokens, encounterApi has placeToken/moveToken/removeToken/setTokenStatus functions, all type-checks pass.</done>
</task>

</tasks>

<verification>
- `python manage.py makemigrations --check` shows no pending migrations
- `npm run typecheck` passes with no errors
- `grep -c 'encounter.*token' terminal/urls.py` returns 4
- `get_active_view_json` response includes encounter_tokens field
</verification>

<success_criteria>
- ActiveView model has encounter_tokens JSONField with migration applied
- 4 API endpoints (place, move, remove, set-status) accessible at /api/gm/encounter/*-token/
- Active view polling response includes encounter_tokens for player updates
- TypeScript types enforce token data shape (TokenData, TokenType, TokenStatus, TokenState)
- Frontend API client has functions for all 4 token operations
- All type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-encounter-tokens/03-01-SUMMARY.md`
</output>
