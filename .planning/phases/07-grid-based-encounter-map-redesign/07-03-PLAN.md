---
phase: 07-grid-based-encounter-map-redesign
plan: 03
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - src/components/domain/encounter/TokenLayer.tsx
  - src/components/gm/MapPreview.tsx
  - src/components/gm/EncounterPanel.tsx
autonomous: true
requirements: [GRID-07, GRID-08, GRID-09]

must_haves:
  truths:
    - "TokenLayer.findRoomAtCell() tests each rect in room.rects for multi-rect rooms"
    - "Tokens placed in the alcove of an L-shaped room are correctly identified as belonging to that room"
    - "MapPreview renders grid maps using the new renderer (wall-segments, floor texture, GM dim)"
    - "MapPreview threads onRoomToggle from EncounterPanel to renderer for GM click-to-reveal"
    - "EncounterPanel room list renders room.name and type badge instead of room.status badge"
    - "EncounterPanel has 'reveal all' and 'hide all' bulk action buttons"
    - "npm run typecheck passes with 0 errors"
  artifacts:
    - path: "src/components/domain/encounter/TokenLayer.tsx"
      provides: "Updated findRoomAtCell testing all rects in GridRoom"
    - path: "src/components/gm/MapPreview.tsx"
      provides: "Grid map rendering + onRoomToggle threading to EncounterMapRenderer"
    - path: "src/components/gm/EncounterPanel.tsx"
      provides: "Room list without status badge, bulk reveal/hide buttons, onRoomToggle wired"
  key_links:
    - from: "TokenLayer.tsx findRoomAtCell"
      to: "GridRoom.rects[]"
      via: "room.rects.some(r => gridX >= r.x && gridX < r.x + r.w && gridY >= r.y && gridY < r.y + r.h)"
      pattern: "rects.some"
    - from: "EncounterPanel.tsx handleRoomToggle"
      to: "MapPreview.tsx onRoomToggle prop"
      via: "MapPreview receives onRoomToggle and forwards to EncounterMapRenderer"
      pattern: "onRoomToggle"
---

<objective>
Update TokenLayer, MapPreview, and EncounterPanel to work with the new GridRoom type and to thread GM click-to-reveal functionality.

Purpose: These three components are consumers of the room schema. Without this plan, tokens will fail to identify L-shaped rooms, MapPreview will not render grid maps, and EncounterPanel will show TypeScript errors accessing the removed room.status field.
Output: Updated TokenLayer (multi-rect room test), updated MapPreview (grid rendering + onRoomToggle), updated EncounterPanel (room list + bulk actions + onRoomToggle wiring).
</objective>

<execution_context>
@/home/gjohnson/.claude/get-shit-done/workflows/execute-plan.md
@/home/gjohnson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-grid-based-encounter-map-redesign/07-RESEARCH.md
@.planning/phases/07-grid-based-encounter-map-redesign/07-01-SUMMARY.md
@src/types/encounterMap.ts
@src/components/domain/encounter/TokenLayer.tsx
@src/components/gm/MapPreview.tsx
@src/components/gm/EncounterPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TokenLayer findRoomAtCell for multi-rect rooms</name>
  <files>src/components/domain/encounter/TokenLayer.tsx</files>
  <action>
TokenLayer.tsx currently imports `RoomData` from encounterMap.ts and uses `findRoomAtCell` to identify which room a grid cell belongs to. The old implementation tests a single x/y/width/height rect. Update to support multi-rect rooms.

**Step 1: Update the import** — add `GridRoom` alongside the existing `RoomData` import:
```typescript
import { TokenState, RoomData, GridRoom } from '../../../types/encounterMap';
```

**Step 2: Update the mapRooms prop type** — the prop currently accepts `RoomData[]`. Change it to accept either format:
```typescript
mapRooms?: (RoomData | GridRoom)[];
```

**Step 3: Update findRoomAtCell** — replace the existing implementation with one that handles both old and new room shapes:
```typescript
const findRoomAtCell = (gridX: number, gridY: number): RoomData | GridRoom | null => {
  if (!mapRooms) return null;
  for (const room of mapRooms) {
    // New format: GridRoom has rects array
    if ('rects' in room && Array.isArray(room.rects)) {
      const hit = room.rects.some(r =>
        gridX >= r.x && gridX < r.x + r.w &&
        gridY >= r.y && gridY < r.y + r.h
      );
      if (hit) return room;
    } else {
      // Old format: RoomData has x, y, width, height
      const r = room as RoomData;
      if (gridX >= r.x && gridX < r.x + r.width &&
          gridY >= r.y && gridY < r.y + r.height) {
        return r;
      }
    }
  }
  return null;
};
```

No other changes to TokenLayer — drag logic, ghost token rendering, mouse handlers, and all other code are unchanged. The return type of findRoomAtCell is only used for `room.id` (string) which both RoomData and GridRoom have, so no downstream type issues.
  </action>
  <verify>cd /home/gjohnson/mothership/charon && npm run typecheck 2>&1 | grep -E "TokenLayer|error TS|0 errors" | head -10</verify>
  <done>TokenLayer.tsx compiles cleanly. findRoomAtCell correctly tests room.rects for GridRoom instances, and falls back to x/y/width/height for legacy RoomData.</done>
</task>

<task type="auto">
  <name>Task 2: Update MapPreview and EncounterPanel for grid maps</name>
  <files>
    src/components/gm/MapPreview.tsx
    src/components/gm/EncounterPanel.tsx
  </files>
  <action>
**MapPreview.tsx changes:**

The GM preview panel renders an encounter map and also handles token drag-and-drop for token placement. It needs to:
1. Support grid maps via the isGridEncounterMap branch (delegate to same EncounterMapRenderer as player terminal)
2. Thread the onRoomToggle callback through from EncounterPanel

Add to MapPreviewProps:
```typescript
/** Callback when GM clicks a room on the map to toggle reveal/hide */
onRoomToggle?: (roomId: string, visible: boolean) => void;
```

Add import:
```typescript
import { isGridEncounterMap, GridEncounterMapData } from '@/types/encounterMap';
```

In the render output, find where MapPreview currently renders its own SVG map (the inline room rendering). Wrap it with an isGridEncounterMap check:

Before the existing SVG rendering block, add:
```tsx
// Grid-format maps: delegate to EncounterMapRenderer with GM controls
if (isGridEncounterMap(mapData)) {
  // For grid maps, the EncounterMapRenderer handles all rendering including token layer
  // We wrap it in the same container div as before for sizing
  return (
    <div className="map-preview" style={{ height: height || undefined }}>
      <EncounterMapRenderer
        mapData={mapData as GridEncounterMapData}
        roomVisibility={roomVisibility}
        doorStatus={doorStatus}
        tokens={tokens}
        isGM={isGM ?? true}
        onRoomToggle={onRoomToggle}
        onTokenMove={onTokenMove}
        onTokenRemove={onTokenRemove}
        onTokenStatusToggle={onTokenStatusToggle}
      />
      {/* Token drag-and-drop overlay: the existing drop handlers are on this div */}
    </div>
  );
}
```

Import EncounterMapRenderer if not already imported:
```typescript
import { EncounterMapRenderer } from '@/components/domain/encounter/EncounterMapRenderer';
```

Note: For grid maps, the drag-and-drop token placement from palette still works — it was wired via onDrop on the parent container in EncounterPanel. The renderer itself handles room click-to-reveal internally. If there are TypeScript errors from passing GridEncounterMapData to the old EncounterMapRenderer prop type, cast with `as unknown as EncounterMapData` temporarily and add `// TODO: EncounterMapRenderer accepts GridEncounterMapData in 07-02`.

Actually — by the time Plan 03 runs, Plan 02 will have already updated EncounterMapRenderer to accept GridEncounterMapData. So just pass it directly.

**EncounterPanel.tsx changes:**

1. **Update RoomWithDeck interface** — the current interface extends RoomData and adds `deckId`. Update to handle both old and new room shapes:
   ```typescript
   interface RoomWithDeck {
     id: string;
     name: string;
     deckId: string;
     // Grid format
     rects?: import('@/types/encounterMap').GridRect[];
     type?: string;
     description?: string;
     // Legacy format fields (may be absent in new format)
     status?: string;
   }
   ```

2. **Update allRooms memo** — currently does `{ ...room, deckId: deck.id }`. This still works for both RoomData and GridRoom since spread includes all fields. No change needed here — the spread handles both shapes.

3. **Drop the status badge from the room list item** — find the section rendering `{room.status && (...)}` in the room list renderItem. Remove or comment out the status badge entirely. The new GridRoom has no status field. Replace with an optional type badge:
   ```tsx
   {/* Show room type tag if present (grid format uses type field) */}
   {room.type && room.type !== 'corridor' && (
     <span style={{ fontSize: 10, color: '#3a5a5a', marginLeft: 4 }}>
       [{room.type}]
     </span>
   )}
   ```

4. **Add bulk reveal/hide buttons** — per CONTEXT.md locked decision: both "reveal all" and "hide all" buttons must be available. The current code already has handleRevealAll and handleHideAll functions. If they exist, ensure they're exposed as buttons in the UI. If the buttons are missing from the JSX, add them near the top of the ROOM VISIBILITY section:
   ```tsx
   <div style={{ display: 'flex', gap: 8, marginBottom: 8 }}>
     <Button size="small" onClick={handleRevealAll}
       style={{ flex: 1, fontSize: 11, color: '#4a6b6b', borderColor: '#2a3a3a' }}>
       REVEAL ALL
     </Button>
     <Button size="small" onClick={handleHideAll}
       style={{ flex: 1, fontSize: 11, color: '#8b5555', borderColor: '#2a3a3a' }}>
       HIDE ALL
     </Button>
   </div>
   ```

5. **Thread onRoomToggle into MapPreview** — MapPreview already receives an onRoomToggle if it's in Props. Find where MapPreview is rendered inside EncounterPanel and add the prop:
   ```tsx
   <MapPreview
     mapData={mapData}
     roomVisibility={roomVisibility}
     doorStatus={doorStatus}
     onDoorStatusChange={handleDoorStatusChange}
     showAllRooms={true}
     tokens={encounterTokens}
     isGM={true}
     onTokenPlace={handleTokenPlace}
     onTokenMove={handleTokenMove}
     onTokenRemove={handleTokenRemove}
     onTokenStatusToggle={handleTokenStatusToggle}
     onRoomToggle={handleRoomToggle}  {/* NEW */}
   />
   ```

   The handleRoomToggle function already exists in EncounterPanel — it's the same callback used by the sidebar room list toggle switches. Passing it to MapPreview as onRoomToggle wires GM click-to-reveal on the map preview. No new function needed.

After all changes, run typecheck to confirm 0 errors.
  </action>
  <verify>cd /home/gjohnson/mothership/charon && npm run typecheck 2>&1 | grep -E "error TS|0 errors" | head -10</verify>
  <done>npm run typecheck passes. MapPreview delegates grid maps to EncounterMapRenderer with onRoomToggle. EncounterPanel room list shows type badge instead of status badge. Bulk reveal/hide buttons present. onRoomToggle threaded to MapPreview.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `cd /home/gjohnson/mothership/charon && npm run typecheck` — 0 errors
2. `cd /home/gjohnson/mothership/charon && npm run build` — succeeds
3. Grep confirms multi-rect test: `grep -n "rects.some" src/components/domain/encounter/TokenLayer.tsx` — present
4. Grep confirms bulk buttons: `grep -n "REVEAL ALL\|HIDE ALL" src/components/gm/EncounterPanel.tsx` — both present
5. Grep confirms onRoomToggle in MapPreview props: `grep -n "onRoomToggle" src/components/gm/MapPreview.tsx` — present
6. Confirm status badge removed: `grep -n "room\.status" src/components/gm/EncounterPanel.tsx` — should return nothing in the renderItem JSX (may exist in type annotations but not rendered)
</verification>

<success_criteria>
- TokenLayer handles both legacy RoomData and new GridRoom shapes in findRoomAtCell
- MapPreview renders grid maps via EncounterMapRenderer with onRoomToggle forwarded
- EncounterPanel shows type badge (not status badge) in room list
- Both reveal all / hide all bulk buttons are present in EncounterPanel UI
- onRoomToggle from EncounterPanel is wired to MapPreview
- npm run typecheck and npm run build both pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-grid-based-encounter-map-redesign/07-03-SUMMARY.md`
</output>
