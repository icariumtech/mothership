---
phase: 05-real-time-push-architecture
plan: "04"
type: execute
wave: 4
depends_on:
  - "05-03"
files_modified: []
autonomous: false
requirements:
  - RTMA-01
  - RTMA-02
  - RTMA-03
  - RTMA-04

must_haves:
  truths:
    - "Token movements appear on player terminal within ~200ms of GM action"
    - "Portrait reveals appear on player terminal instantly when GM triggers them"
    - "Switching encounter maps clears portraits and updates terminal without polling delay"
    - "Connection warning toast appears when SSE disconnects after threshold"
    - "Toast auto-dismisses when SSE reconnects"
    - "Server restart resets to STANDBY — GM re-navigates to resume"
    - "Messages polling still works (separate from SSE state updates)"
  artifacts:
    - path: "terminal/active_view_store.py"
      provides: "In-memory state verified as live data source"
    - path: "src/hooks/useSSE.ts"
      provides: "SSE hook verified via browser DevTools EventStream tab"
  key_links:
    - from: "GMConsole (toggle portrait button)"
      to: "Player SharedConsole (NPCPortraitOverlay)"
      via: "POST /api/gm/encounter/toggle-portrait/ -> broadcaster.announce -> EventSource -> React state"
      pattern: "useSSE.*onEvent"
---

<objective>
Human verification of the complete real-time push architecture — confirm instant updates, connection resilience, and database integrity across the full GM → SSE → player flow.

Purpose: End-to-end validation that latency is eliminated for the highest-impact operations (token moves, portrait reveals) and that the system degrades gracefully on disconnect.
Output: Verified real-time system with documented pass/fail for each behavior.
</objective>

<execution_context>
@/home/gjohnson/.claude/get-shit-done/workflows/execute-plan.md
@/home/gjohnson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Human Verification: End-to-End Real-Time Push Architecture</name>
  <action>No automated action — this checkpoint verifies the work completed in plans 05-01 through 05-03.</action>
  <what-built>
Complete real-time push architecture:
- Server-Sent Events endpoint at /api/active-view/stream/ replacing 2-second polling
- In-memory ActiveView state store (SQLite ActiveView table dropped)
- All 17 GM write endpoints announce SSE events on state change
- useSSE hook in SharedConsole (failureThreshold: 5) and GMConsole (failureThreshold: 2)
- SSEConnectionToast shown on repeated connection failures, auto-dismissed on recovery
- Message model and SQLite database retained intact
  </what-built>
  <how-to-verify>
Start the Django server and Vite dev server in separate terminals:
```bash
python manage.py runserver
npm run dev
```

**Test 1 — SSE stream delivers initial state**
Open browser DevTools on the terminal page (http://127.0.0.1:5173/terminal/ or http://127.0.0.1:8000/terminal/).
In Network tab, find the `active-view/stream/` request. It should show as type "eventsource" or "text/event-stream" with status 200 and remain open. In the EventStream tab (Chrome) or Messages tab (Firefox), confirm you see an `activeview` named event with the full state JSON.

**Test 2 — Token movement latency**
1. Set an encounter location in GM console
2. Place a token on the encounter map
3. Open the player terminal (http://127.0.0.1:8000/terminal/) in another tab/window
4. In GM console, drag and drop the token to a new cell
5. EXPECTED: Token moves on player terminal within ~200ms (visually instant, not after 2 seconds)

**Test 3 — Portrait reveal latency**
1. From GM console Encounter panel, click "SHOW" on an NPC portrait
2. EXPECTED: Portrait overlay appears on player terminal instantly (not after 2 seconds)
3. Click "DISMISS" — portrait disappears on player terminal instantly

**Test 4 — Connection warning toast**
1. Stop the Django server (Ctrl+C)
2. Wait ~10 seconds
3. EXPECTED on GMConsole: Toast appears at top of screen ("Connection lost — retrying...") after ~6 seconds (2 failures x 3 second retry delay)
4. EXPECTED on SharedConsole (player terminal): Toast appears after ~15 seconds (5 failures x 3 second retry delay)
5. Restart Django server
6. EXPECTED: Toast disappears automatically on both consoles once SSE reconnects

**Test 5 — Database integrity**
```bash
python manage.py showmigrations terminal
python -c "from terminal.models import Message; print('Message count:', Message.objects.count())"
```
EXPECTED: Migration 0017 applied; Message model accessible; no pending ActiveView migrations.

**Test 6 — Messages polling unaffected**
1. Send a test broadcast message from GM console
2. EXPECTED: Message appears in player messages (/messages/) via existing polling — no regression

**Test 7 — Server restart behavior**
1. Note current encounter state in GM console
2. Restart Django server: `python manage.py runserver`
3. EXPECTED: Terminal resets to STANDBY (in-memory state cleared)
4. EXPECTED: GM re-navigates by setting encounter location — state rebuilds correctly
  </how-to-verify>
  <verify>Run all 7 tests above and confirm each passes.</verify>
  <done>All 7 tests pass: SSE delivers initial state, token moves and portrait reveals are instant, toast appears/dismisses correctly, messages polling works, server restart resets to STANDBY cleanly.</done>
  <resume-signal>
Type "approved" if all 7 tests pass.
Describe any failures with the test number (e.g., "Test 2 failed — token still delayed 2 seconds").
  </resume-signal>
</task>

</tasks>

<verification>
Human verification is the primary check for this plan. Additional automated checks after approval:
```bash
cd /home/gjohnson/mothership/charon

# Confirm no active-view polling vestiges
grep -n "setInterval" src/entries/SharedConsole.tsx src/entries/GMConsole.tsx

# Confirm SSE URL registered
python -c "from django.urls import reverse; print(reverse('active_view_stream'))"

# Build passes
npm run build 2>&1 | tail -5
```
</verification>

<success_criteria>
All 7 manual tests pass:
1. SSE stream delivers initial state as named 'activeview' event
2. Token moves appear on player terminal within ~200ms
3. Portrait reveals appear on player terminal instantly
4. Connection warning toast appears after threshold (GM: 2 attempts, player: 5 attempts)
5. Toast auto-dismisses on reconnect
6. Message model intact; messages polling unaffected
7. Server restart resets to STANDBY; state rebuilds correctly after GM re-navigates
</success_criteria>

<output>
After completion, create `.planning/phases/05-real-time-push-architecture/05-04-SUMMARY.md`
</output>
