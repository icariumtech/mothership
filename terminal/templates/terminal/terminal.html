{% extends 'terminal/base.html' %}

{% block title %}Terminal - Incoming Messages{% endblock %}

{% block header %}MU-TH-UR 6000 COMMUNICATIONS TERMINAL{% endblock %}
{% block subtitle %}SYSTEM ACTIVE - {{ messages|length }} MESSAGE(S) IN QUEUE{% endblock %}

{% block extra_css %}
<style>
    .message-container {
        margin-bottom: 30px;
    }

    .message {
        border: 1px solid #00ff00;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #001100;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #004400;
    }

    .message-sender {
        font-weight: bold;
        letter-spacing: 1px;
    }

    .message-time {
        font-size: 11px;
        color: #00aa00;
    }

    .message-content {
        white-space: pre-wrap;
        line-height: 1.8;
    }

    .priority-indicator {
        display: inline-block;
        padding: 2px 8px;
        margin-left: 10px;
        font-size: 10px;
        border: 1px solid;
    }

    .priority-LOW {
        color: #008800;
        border-color: #008800;
    }

    .priority-NORMAL {
        color: #00ff00;
        border-color: #00ff00;
    }

    .priority-HIGH {
        color: #ffff00;
        border-color: #ffff00;
        animation: pulse 1s infinite;
    }

    .priority-CRITICAL {
        color: #ff0000;
        border-color: #ff0000;
        animation: pulse 0.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .no-messages {
        text-align: center;
        padding: 40px;
        color: #006600;
        font-size: 14px;
    }

    .blink {
        animation: blink 1s step-start infinite;
    }

    @keyframes blink {
        50% { opacity: 0; }
    }

    .new-message-alert {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #00ff00;
        color: #000;
        padding: 15px 25px;
        font-weight: bold;
        letter-spacing: 2px;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.8);
        z-index: 2000;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .message.new-message {
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="message-container" id="message-container">
    {% if messages %}
        {% for message in messages %}
        <div class="message" data-message-id="{{ message.id }}">
            <div class="message-header">
                <div>
                    <span class="message-sender">{{ message.sender }}</span>
                    <span class="priority-indicator priority-{{ message.priority }}">
                        {{ message.priority }}
                    </span>
                </div>
                <div class="message-time">
                    {{ message.created_at|date:"Y-m-d H:i:s" }} UTC
                </div>
            </div>
            <div class="message-content">{{ message.content }}</div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-messages" id="no-messages">
            <p>&gt; NO NEW MESSAGES</p>
            <p>&gt; SYSTEM STANDBY</p>
            <p class="blink">&gt; _</p>
        </div>
    {% endif %}
</div>

<script>
// Real-time message polling
(function() {
    let latestMessageId = {{ messages.0.id|default:0 }};
    const pollInterval = 3000; // Check every 3 seconds

    function checkForNewMessages() {
        fetch('/terminal/api/messages/?since=' + latestMessageId)
            .then(response => response.json())
            .then(data => {
                if (data.count > 0) {
                    // New messages arrived!
                    showNewMessageAlert(data.count);
                    prependMessages(data.messages);

                    // Update latest message ID
                    if (data.messages.length > 0) {
                        latestMessageId = Math.max(...data.messages.map(m => m.id));
                    }
                }
            })
            .catch(error => {
                console.error('Error checking for messages:', error);
            });
    }

    function showNewMessageAlert(count) {
        // Remove existing alert if any
        const existingAlert = document.querySelector('.new-message-alert');
        if (existingAlert) {
            existingAlert.remove();
        }

        // Create new alert
        const alert = document.createElement('div');
        alert.className = 'new-message-alert';
        alert.textContent = `NEW MESSAGE${count > 1 ? 'S' : ''} RECEIVED`;
        document.body.appendChild(alert);

        // Remove alert after 3 seconds
        setTimeout(() => {
            alert.remove();
        }, 3000);
    }

    function prependMessages(messages) {
        const container = document.getElementById('message-container');
        const noMessagesDiv = document.getElementById('no-messages');

        // Remove "no messages" placeholder if it exists
        if (noMessagesDiv) {
            noMessagesDiv.remove();
        }

        // Add new messages at the top (they come in reverse order from API)
        messages.reverse().forEach(msg => {
            const messageDiv = createMessageElement(msg);
            container.insertBefore(messageDiv, container.firstChild);
        });
    }

    function createMessageElement(msg) {
        const div = document.createElement('div');
        div.className = 'message new-message';
        div.setAttribute('data-message-id', msg.id);

        div.innerHTML = `
            <div class="message-header">
                <div>
                    <span class="message-sender">${escapeHtml(msg.sender)}</span>
                    <span class="priority-indicator priority-${msg.priority}">
                        ${msg.priority}
                    </span>
                </div>
                <div class="message-time">
                    ${msg.created_at} UTC
                </div>
            </div>
            <div class="message-content">${escapeHtml(msg.content)}</div>
        `;

        return div;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Start polling
    setInterval(checkForNewMessages, pollInterval);

    console.log('Real-time message polling started (every ' + (pollInterval/1000) + ' seconds)');
})();
</script>
{% endblock %}
