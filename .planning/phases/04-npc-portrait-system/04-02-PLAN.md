---
phase: 04-npc-portrait-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/gmConsole.ts
  - src/entries/SharedConsole.tsx
  - src/services/encounterApi.ts
autonomous: true
requirements:
  - PORT-01

must_haves:
  truths:
    - "TypeScript types for encounter_active_portraits and encounter_npc_data exist and are used consistently"
    - "encounterApi.togglePortrait(npcId) method is callable from EncounterPanel"
    - "SharedConsole's ActiveView interface includes encounter_active_portraits and encounter_npc_data"
  artifacts:
    - path: "src/types/gmConsole.ts"
      provides: "ActiveView type with encounter_active_portraits and NpcPortraitData interface"
      contains: "encounter_active_portraits"
    - path: "src/entries/SharedConsole.tsx"
      provides: "SharedConsole ActiveView interface extended with portrait fields"
      contains: "encounter_active_portraits"
    - path: "src/services/encounterApi.ts"
      provides: "togglePortrait API method"
      contains: "togglePortrait"
  key_links:
    - from: "src/types/gmConsole.ts:ActiveView"
      to: "src/components/gm/EncounterPanel.tsx"
      via: "imported ActiveView type"
      pattern: "encounter_active_portraits"
    - from: "src/services/encounterApi.ts:togglePortrait"
      to: "terminal/views.py:api_encounter_toggle_portrait"
      via: "POST /api/gm/encounter/toggle-portrait/"
      pattern: "toggle-portrait"
---

<objective>
Add TypeScript type definitions and an API service method for the NPC portrait system. Extends existing interfaces in gmConsole.ts and SharedConsole.tsx, and adds togglePortrait to encounterApi.ts.

Purpose: Plans 03 depend on these types and the API client. This plan runs in parallel with the backend plan (04-01) since it only touches TypeScript files.

Output: Updated gmConsole.ts (ActiveView + NpcPortraitData types), updated SharedConsole.tsx ActiveView interface, and new togglePortrait method in encounterApi.ts.
</objective>

<execution_context>
@/home/gjohnson/.claude/get-shit-done/workflows/execute-plan.md
@/home/gjohnson/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/04-npc-portrait-system/04-CONTEXT.md
@.planning/phases/04-npc-portrait-system/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NPC portrait types to gmConsole.ts and SharedConsole.tsx</name>
  <files>src/types/gmConsole.ts, src/entries/SharedConsole.tsx</files>
  <action>
    **Part A — src/types/gmConsole.ts**

    Add a new interface before the `ActiveView` interface:

    ```typescript
    export interface NpcPortraitData {
      id: string;
      name: string;
      portrait: string;  // URL path like "/data/campaign/NPCs/images/lucia_vance.png" or ""
    }
    ```

    In the existing `ActiveView` interface, add these fields after `encounter_tokens`:

    ```typescript
    encounter_active_portraits: string[];          // ordered list of NPC IDs
    encounter_npc_data: { [id: string]: NpcPortraitData };  // NPC lookup map
    ```

    **Part B — src/entries/SharedConsole.tsx**

    In the local `ActiveView` interface (the one defined inline in SharedConsole.tsx, around line 38), add these fields after the `encounter_tokens` field:

    ```typescript
    // Portrait overlay state
    encounter_active_portraits?: string[];
    encounter_npc_data?: { [id: string]: { id: string; name: string; portrait: string } };
    ```

    Use optional (?) since these fields won't exist in old cached responses. Keep inline type definition (don't import from gmConsole.ts) to match the existing pattern in SharedConsole.tsx where a local interface is used.
  </action>
  <verify>
    ```bash
    cd /home/gjohnson/mothership/charon && npm run typecheck 2>&1 | head -30
    ```
    No new TypeScript errors. Verify the types are syntactically correct.
  </verify>
  <done>
    - NpcPortraitData interface exported from src/types/gmConsole.ts
    - ActiveView in gmConsole.ts has encounter_active_portraits and encounter_npc_data fields
    - SharedConsole.tsx local ActiveView interface has encounter_active_portraits? and encounter_npc_data? fields
    - npm run typecheck reports no new errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add togglePortrait method to encounterApi.ts</name>
  <files>src/services/encounterApi.ts</files>
  <action>
    In src/services/encounterApi.ts, add a new function before the `export const encounterApi` object:

    ```typescript
    /**
     * Toggle an NPC portrait display on the terminal (GM only).
     * If npcId is active, dismisses it. If not active, shows it.
     */
    async function togglePortrait(npcId: string): Promise<{ success: boolean; active_portraits: string[] }> {
      const response = await api.post<{ success: boolean; active_portraits: string[] }>(
        '/gm/encounter/toggle-portrait/',
        { npc_id: npcId }
      );
      return response.data;
    }
    ```

    Then add `togglePortrait` to the `encounterApi` export object:

    ```typescript
    export const encounterApi = {
      // ... existing methods ...
      togglePortrait,
    };
    ```

    Place the function after `getTokenImages` and before the export object.
  </action>
  <verify>
    ```bash
    cd /home/gjohnson/mothership/charon && npm run typecheck 2>&1 | head -30
    grep -n "togglePortrait" /home/gjohnson/mothership/charon/src/services/encounterApi.ts
    ```
    Both the function definition and export should appear. No TypeScript errors.
  </verify>
  <done>
    - togglePortrait function defined in encounterApi.ts
    - togglePortrait exported from encounterApi object
    - npm run typecheck passes
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` — zero errors
2. `grep -n "encounter_active_portraits\|NpcPortraitData" src/types/gmConsole.ts` — both present
3. `grep -n "encounter_active_portraits" src/entries/SharedConsole.tsx` — present in local interface
4. `grep -n "togglePortrait" src/services/encounterApi.ts` — function definition and export both present
</verification>

<success_criteria>
- NpcPortraitData interface exported from gmConsole.ts
- encounter_active_portraits and encounter_npc_data added to ActiveView in both gmConsole.ts and SharedConsole.tsx
- encounterApi.togglePortrait() exists and POSTs to /api/gm/encounter/toggle-portrait/
- npm run typecheck clean
</success_criteria>

<output>
After completion, create `.planning/phases/04-npc-portrait-system/04-02-SUMMARY.md` with what was built, key file paths modified, and any decisions made during implementation.
</output>
